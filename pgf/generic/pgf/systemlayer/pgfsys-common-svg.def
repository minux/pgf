% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS $Header: /cvsroot/pgf/pgf/generic/pgf/systemlayer/pgfsys-common-svg.def,v 1.53 2016/02/02 22:03:39 tantau Exp $


% Driver commands for svg



% Helping functions:
\def\pgf@sys@svg@make@defs#1{\pgf@sys@fail{svg defs}}
\def\pgf@sys@svg@ref@defs#1{\pgf@sys@fail{svg defs}}
\let\pgf@sys@svgpath=\pgfutil@empty
\def\pgf@sys@svgnum#1{%
  {%
    \pgf@x=#1\relax%
    \edef\temp{\expandafter\Pgf@geT\the\pgf@x\space}%
    \pgfutil@toks@\expandafter\expandafter\expandafter{\expandafter\pgf@sys@svgpath\temp}%
    \xdef\pgf@sys@svgpath{\the\pgfutil@toks@}%
  }%
}
\def\pgf@sys@addtosvgpath#1{\pgfutil@g@addto@macro\pgf@sys@svgpath{#1\space}}
\def\pgf@sys@flushsvgpath{\pgfsysprotocol@literal{\pgf@sys@svgpath}\global\let\pgf@sys@svgpath=\pgfutil@empty}
\def\pgf@sys@svg@gs#1{{\pgfsysprotocol@literal{<g #1>\pgfsys@svg@newline }}\global\advance\pgf@sys@svg@scopecount by1\relax}
\newcount\pgf@sys@svg@objectcount

{\catcode`\%=12
\gdef\pgf@sys@svg@percentchar{%}
}
{\catcode`\#=11
\gdef\pgf@sys@svg@hash{#}
}

% Path construction:
\def\pgfsys@lineto#1#2{\pgf@sys@addtosvgpath{L }\pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}}
\def\pgfsys@moveto#1#2{\pgf@sys@addtosvgpath{M }\pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}}
\def\pgfsys@curveto#1#2#3#4#5#6{%
  \pgf@sys@addtosvgpath{C }%
  \pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}%
  \pgf@sys@svgnum{#3}\pgf@sys@svgnum{#4}%
  \pgf@sys@svgnum{#5}\pgf@sys@svgnum{#6}}
\def\pgfsys@rect#1#2#3#4{%
  \pgfsys@moveto{#1}{#2}%
  \pgf@sys@addtosvgpath{h }\pgf@sys@svgnum{#3}%
  \pgf@sys@addtosvgpath{v }\pgf@sys@svgnum{#4}%
  \pgf@sys@addtosvgpath{h }{\pgf@x=#3\pgf@x=-\pgf@x\pgf@sys@svgnum{\pgf@x}}%
  \pgfsys@closepath}
\def\pgfsys@closepath{\pgf@sys@addtosvgpath{Z}}

% Path usage:
\newif\ifpgf@sys@svg@clipnext
\def\pgf@sys@svg@possiblyclippedpath#1{%
  \ifpgf@sys@svg@clipnext%
    \pgf@sys@svg@stagedfalse%
    \pgfsys@if@fresh@currentid{\csname pgf@sys@att@setup@\pgfsys@id@refcurrent\endcsname}{}%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgfsysprotocol@literal{%
      <clipPath id="\pgfsys@if@fresh@currentid{\pgfsys@id@refcurrent}{pgfcp\the\pgf@sys@svg@objectcount}clip">
      <path id="\pgfsys@if@fresh@currentid{\pgfsys@id@refcurrent}{pgfcp\the\pgf@sys@svg@objectcount}"
      \ifpgf@sys@svg@staged visibility="hidden" \fi d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{"/> </clipPath>\pgfsys@svg@newline }
    \pgfsysprotocol@literal{<use xlink:href="\#\pgfsys@if@fresh@currentid{\pgfsys@id@refcurrent}{pgfcp\the\pgf@sys@svg@objectcount}" #1/>\pgfsys@svg@newline }%
    \pgf@sys@svg@gs{clip-path="url(\#\pgfsys@if@fresh@currentid{\pgfsys@id@refcurrent}{pgfcp\the\pgf@sys@svg@objectcount}clip)"}
    \pgf@sys@svg@clipnextfalse%
  \else%
    \pgf@sys@svg@stagedfalse%
    \pgfsys@if@fresh@currentid{\csname pgf@sys@att@setup@\pgfsys@id@refcurrent\endcsname}{}%
    \pgfsysprotocol@literal{<path\pgfsys@if@fresh@currentid{ id="\pgfsys@id@refcurrent"}{} \ifpgf@sys@svg@staged visibility="hidden" \fi d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{" #1/>\noexpand\pgfsys@svg@newline }
  \fi%
  \pgfsys@invalidate@currentid%
}
\def\pgfsys@stroke{\pgf@sys@svg@possiblyclippedpath{style="fill:none"}}
\def\pgfsys@fill{\pgf@sys@svg@possiblyclippedpath{style="stroke:none"}}
\def\pgfsys@fillstroke{\pgf@sys@svg@possiblyclippedpath{}}
\def\pgfsys@clipnext{\pgf@sys@svg@clipnexttrue}
\def\pgfsys@discardpath{%
  \ifpgf@sys@svg@clipnext%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgf@sys@svg@stagedfalse%
    \pgfsys@if@fresh@currentid{\csname pgf@sys@att@setup@\pgfsys@id@refcurrent\endcsname}{}%
    \pgfsysprotocol@literal{%
      <clipPath id="pgfcp\the\pgf@sys@svg@objectcount">%
      <path\pgfsys@if@fresh@currentid{ id="\pgfsys@id@refcurrent"}{}
      \ifpgf@sys@svg@staged visibility="hidden" \fi d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{"/> </clipPath>\pgfsys@svg@newline }
    \pgf@sys@svg@gs{clip-path="url(\#pgfcp\the\pgf@sys@svg@objectcount)"}
    \pgf@sys@svg@clipnextfalse%
  \else%
    \global\let\pgf@sys@svgpath=\pgfutil@empty
  \fi%
  \pgfsys@invalidate@currentid%
}

% Fill rules:
\def\pgfsys@eoruletrue{\pgf@sys@svg@gs{fill-rule="evenodd"}}
\def\pgfsys@eorulefalse{\pgf@sys@svg@gs{fill-rule="nonzero"}}

% Transparency:
\def\pgfsys@opacity#1{\pgf@sys@svg@gs{opacity="#1"}}
\def\pgfsys@stroke@opacity#1{\pgf@sys@svg@gs{stroke-opacity="#1"}}
\def\pgfsys@fill@opacity#1{\pgf@sys@svg@gs{fill-opacity="#1"}\def\pgf@sys@svg@opacity{#1}}
\def\pgf@sys@svg@opacity{1}
\def\pgfsys@transparencygroupfrombox#1{%
  \setbox#1=\hbox{%
  \pgfsys@invoke{<g opacity="\pgf@sys@svg@opacity" stroke-opacity="1" fill-opacity="1">\pgfsys@svg@newline }%
  \box#1%
  \pgfsys@invoke{</g>\pgfsys@svg@newline }%
  }%
}

% Transformation:
\def\pgfsys@transformcm#1#2#3#4#5#6{%
  {\pgf@x=#5\pgf@y=#6%
  \pgf@sys@svg@gs{transform="matrix(#1,#2,#3,#4,\pgf@sys@tonumber{\pgf@x},\pgf@sys@tonumber{\pgf@y})"}}}

% View boxes
\def\pgfsys@viewboxmeet{\pgf@sys@svg@viewbox{meet}}
\def\pgfsys@viewboxslice{\pgf@sys@svg@viewbox{slice}}
\def\pgf@sys@svg@viewbox#1#2#3#4#5#6#7#8#9{%
  {%
    \pgf@x#2%
    \pgf@y#3%
    \pgf@xa#4%
    \pgf@ya#5%
    \advance\pgf@xa by-\pgf@x%
    \advance\pgf@ya by-\pgf@y%
    \pgf@xb#6%
    \pgf@yb#7%
    \pgf@xc#8%
    \pgf@yc#9%
    \advance\pgf@xc by-\pgf@xb%
    \advance\pgf@yc by-\pgf@yb%
    \pgf@sys@svg@stagedfalse%
    \pgfsys@if@fresh@currentid{\csname pgf@sys@att@setup@\pgfsys@id@refcurrent\endcsname}{}%
    \pgfsysprotocol@literal{<svg
      overflow="visible"
      preserveAspectRatio="xMidYMid #1"
      \pgfsys@if@fresh@currentid{ id="\pgfsys@id@refcurrent"}{}
      \ifpgf@sys@svg@staged visibility="hidden" \fi
      x="\pgf@sys@tonumber{\pgf@x}"
      y="\pgf@sys@tonumber{\pgf@y}"
      width="\pgf@sys@tonumber{\pgf@xa}"
      height="\pgf@sys@tonumber{\pgf@ya}"
      viewBox="\pgf@sys@tonumber{\pgf@xb} \pgf@sys@tonumber{\pgf@yb} \pgf@sys@tonumber{\pgf@xc} \pgf@sys@tonumber{\pgf@yc}">}%
    \pgfsys@invalidate@currentid%
  }%
}
\def\pgfsys@endviewbox{\pgfsysprotocol@literal{</svg>}}


% Scopes
\newcount\pgf@sys@svg@scopecount

\def\pgfsys@beginscope{\pgfsys@beginscope@{}}%
\def\pgfsys@beginscope@#1{%
  \edef\pgf@sys@svg@thescopecount{\the\pgf@sys@svg@scopecount}%
  \begingroup%
    \pgf@sys@svg@scopecount=1\relax%
    \pgfsysprotocol@literal{<g#1>\pgfsys@svg@newline }%
}
\def\pgfsys@endscope{%
    \loop%
      \pgfsysprotocol@literal{</g>\pgfsys@svg@newline }%
      \advance\pgf@sys@svg@scopecount by-1\relax%
    \ifnum\pgf@sys@svg@scopecount>0\relax%
    \repeat%
  \endgroup%
  \global\pgf@sys@svg@scopecount=\pgf@sys@svg@thescopecount\relax%  
}
\def\pgfsys@begin@idscope{%
  \begingroup%
    \pgfsys@if@fresh@currentid{%
      \pgf@sys@svg@stagedfalse%
      \csname pgf@sys@att@setup@\pgfsys@id@refcurrent\endcsname%
      \pgfsys@beginscope@{ id="\pgfsys@id@refcurrent" \ifpgf@sys@svg@staged visibility="hidden" \fi}%
      \csname pgf@sys@att@beg@\pgfsys@id@refcurrent\endcsname%
      \expandafter\let\expandafter\pgf@sys@svg@end@id@scope@code\csname pgf@sys@att@end@\pgfsys@id@refcurrent\endcsname%
      \let\pgf@sys@svg@end@id@scope\pgfsys@endscope%
    }{%
      \let\pgf@sys@svg@end@id@scope@code\relax%
      \let\pgf@sys@svg@end@id@scope\relax%
    }%
    \expandafter\global\expandafter\let\csname pgf@sys@att@beg@\pgfsys@id@refcurrent\endcsname\relax%
    \expandafter\global\expandafter\let\csname pgf@sys@att@end@\pgfsys@id@refcurrent\endcsname\relax%
    \pgfsys@invalidate@currentid%
      \begingroup%
}
\def\pgfsys@end@idscope{%
      \endgroup%
    \pgf@sys@svg@end@id@scope@code%
    \pgf@sys@svg@end@id@scope%
  \endgroup%
}

% IDs

\def\pgfsys@clean@type#1#2{%
  \let\pgf@id@replaced\pgfutil@empty%
  \edef\pgf@id@temp{#2}%
  \expandafter\pgf@id@replace@dots\pgf@id@temp.\pgf@stop%
  \let\pgf@id@temp\pgf@id@replaced%
  \let\pgf@id@replaced\pgfutil@empty%
  \expandafter\expandafter\expandafter\pgf@id@replace@spaces\expandafter\pgf@id@temp\space\pgf@stop%
  \let#1\pgf@id@replaced%
}
\def\pgf@id@replace@dots#1.{%
  \pgfutil@ifnextchar\pgf@stop{\expandafter\def\expandafter\pgf@id@replaced\expandafter{\pgf@id@replaced#1}\pgfutil@gobble}%
  {\expandafter\def\expandafter\pgf@id@replaced\expandafter{\pgf@id@replaced#1_}\pgf@id@replace@dots}%
}
\def\pgf@id@replace@spaces#1 {%
  \pgfutil@ifnextchar\pgf@stop{\expandafter\def\expandafter\pgf@id@replaced\expandafter{\pgf@id@replaced#1}\pgfutil@gobble}%
  {\expandafter\def\expandafter\pgf@id@replaced\expandafter{\pgf@id@replaced#1__}\pgf@id@replace@spaces}%
}


% Graphics state
\def\pgfsys@setdash#1#2{%
  {%
    \pgf@xa#2\relax%
    \edef\pgf@test@dashpattern{#1}%
    \ifx\pgf@test@dashpattern\pgfutil@empty%
      \pgf@sys@svg@gs{stroke-dasharray="none" stroke-dashoffset="\pgf@sys@tonumber\pgf@xa"}%
    \else%
      \let\pgf@sys@svg@parsed@dash\pgfutil@empty%
      \expandafter\pgf@sys@svg@parse@dash\pgf@test@dashpattern,\relax%
      \pgf@sys@svg@gs{stroke-dasharray="\pgf@sys@svg@parsed@dash" stroke-dashoffset="\pgf@sys@tonumber\pgf@xa"}%
    \fi%
  }%
}
\def\pgf@sys@svg@parse@dash#1,{%
  \pgf@x#1\relax%
  \pgfutil@ifnextchar\relax{%
    \edef\pgf@sys@svg@parsed@dash{\pgf@sys@svg@parsed@dash\pgf@sys@tonumber\pgf@x}%
  }{%
    \edef\pgf@sys@svg@parsed@dash{\pgf@sys@svg@parsed@dash\pgf@sys@tonumber\pgf@x,}%
    \pgf@sys@svg@parse@dash%
  }%
}
\def\pgfsys@setlinewidth#1{{\pgf@x=#1\pgf@sys@svg@gs{stroke-width="\pgf@sys@tonumber{\pgf@x}"}}}
\def\pgfsys@setmiterlimit#1{\pgf@sys@svg@gs{stroke-miterlimit="#1"}}
\def\pgfsys@buttcap{\pgf@sys@svg@gs{stroke-linecap="butt"}}
\def\pgfsys@roundcap{\pgf@sys@svg@gs{stroke-linecap="round"}}
\def\pgfsys@rectcap{\pgf@sys@svg@gs{stroke-linecap="square"}}
\def\pgfsys@miterjoin{\pgf@sys@svg@gs{stroke-linejoin="miter"}}
\def\pgfsys@roundjoin{\pgf@sys@svg@gs{stroke-linejoin="round"}}
\def\pgfsys@beveljoin{\pgf@sys@svg@gs{stroke-linejoin="bevel"}}

% Invisibility
\def\pgfsys@begininvisible{\pgfsysprotocol@literal{<g visibility="hidden">\pgfsys@svg@newline }}
\def\pgfsys@endinvisible{\pgfsysprotocol@literal{</g>}}


%
% Color management
% 

\def\pgf@sys@svg@color@rgb#1,#2,#3\relax{%
 {%
    \pgf@xa=#1pt%
    \pgf@xa=100\pgf@xa%
    \pgf@xb=#2pt%
    \pgf@xb=100\pgf@xb%
    \pgf@xc=#3pt%
    \pgf@xc=100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xb\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xc\pgf@sys@svg@percentchar)}%
  }%
}
\def\pgf@sys@svg@color@cmy#1,#2,#3\relax{%
  {%
    \pgf@xa=1pt%
    \advance\pgf@xa by-#1pt%
    \pgf@xa=100\pgf@xa%
    \pgf@xb=1pt%
    \advance\pgf@xb by-#2pt%
    \pgf@xb=100\pgf@xb%
    \pgf@xc=1pt%
    \advance\pgf@xc by-#3pt%
    \pgf@xc=100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xb\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xc\pgf@sys@svg@percentchar)}%
  }%
}
\def\pgf@sys@svg@color@cmyk#1,#2,#3,#4\relax{%
  {%
    \pgf@xa=1pt%
    \advance\pgf@xa by-#4pt%
    \pgf@xa=#1\pgf@xa%
    \advance\pgf@xa by#4pt%
    \advance\pgf@xa by-1pt%
    \pgf@xa=-100\pgf@xa%
    \pgf@xb=1pt%
    \advance\pgf@xb by-#4pt%
    \pgf@xb=#2\pgf@xb%
    \advance\pgf@xb by#4pt%
    \advance\pgf@xb by-1pt%
    \pgf@xb=-100\pgf@xb%
    \pgf@xc=1pt%
    \advance\pgf@xc by-#4pt%
    \pgf@xc=#3\pgf@xc%
    \advance\pgf@xc by#4pt%
    \advance\pgf@xc by-1pt%
    \pgf@xc=-100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xb\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xc\pgf@sys@svg@percentchar)}%
  }%
}
\def\pgf@sys@svg@color@gray#1\relax{%
 {%
    \pgf@xa=#1pt%
    \pgf@xa=100\pgf@xa%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar,\pgf@sys@tonumber\pgf@xa\pgf@sys@svg@percentchar)}%
  }%
}

\def\pgf@sys@svg@gs@color#1{%
  \ifpgfpicture\pgf@sys@svg@gs{#1}\fi%
}

\def\pgf@sys@svg@colorpop{\special{color pop}}

\def\pgfsys@color@rgb@stroke#1#2#3{%
  \pgf@sys@svg@color@rgb#1,#2,#3\relax%
  \pgf@sys@svg@gs@color{stroke="\pgf@sys@svg@prepared"}}
\def\pgfsys@color@rgb@fill#1#2#3{%
  \ifpgfpicture%
    \pgf@sys@svg@color@rgb#1,#2,#3\relax%
    \pgf@sys@svg@gs@color{fill="\pgf@sys@svg@prepared"}%
  \else%
    \special{color push rgb #1 #2 #3}%
    \aftergroup\pgf@sys@svg@colorpop%
  \fi}
\def\pgfsys@color@cmyk@stroke#1#2#3#4{%
  \pgf@sys@svg@color@cmyk#1,#2,#3,#4\relax%
  \pgf@sys@svg@gs@color{stroke="\pgf@sys@svg@prepared"}}
\def\pgfsys@color@cmyk@fill#1#2#3#4{%
  \ifpgfpicture%
    \pgf@sys@svg@color@cmyk#1,#2,#3,#4\relax%
    \pgf@sys@svg@gs@color{fill="\pgf@sys@svg@prepared"}%
  \else%
    \special{color push cmyk #1 #2 #3}%
    \aftergroup\pgf@sys@svg@colorpop%
  \fi}
\def\pgfsys@color@cmy@stroke#1#2#3{%
  \pgf@sys@svg@color@cmy#1,#2,#3\relax%
  \pgf@sys@svg@gs@color{stroke="\pgf@sys@svg@prepared"}}
\def\pgfsys@color@cmy@fill#1#2#3{%
  \ifpgfpicture%
    \pgf@sys@svg@color@cmy#1,#2,#3\relax%
    \pgf@sys@svg@gs@color{fill="\pgf@sys@svg@prepared"}
  \else%
    \special{color push cmyk #1 #2 #3 0}%
    \aftergroup\pgf@sys@svg@colorpop%
  \fi}
\def\pgfsys@color@gray@stroke#1{%
  \pgf@sys@svg@color@gray#1\relax%
  \pgf@sys@svg@gs@color{stroke="\pgf@sys@svg@prepared"}}
\def\pgfsys@color@gray@fill#1{%
  \ifpgfpicture%
    \pgf@sys@svg@color@gray#1\relax%
    \pgf@sys@svg@gs@color{fill="\pgf@sys@svg@prepared"}%
  \else%
    \special{color push gray #1}%
    \aftergroup\pgf@sys@svg@colorpop%
  \fi}


% Shadings:
\def\pgf@sys@svg@shading@stops{%
  % Step 1: Compute 1/\pgf@sys@shading@end@pos
  \pgf@x=\pgf@sys@shading@end@pos\relax%
  \c@pgf@counta=\pgf@x\relax%
  \divide\c@pgf@counta by4096\relax%
  % Step 2: Insert stops.
  \expandafter\pgf@sys@svg@shading@dostops\pgf@sys@shading@ranges%
    % dummy for end:
    {{\pgf@sys@shading@end@pos}{\pgf@sys@shading@end@pos}{\pgf@sys@shading@end@rgb}{\pgf@sys@shading@end@rgb}}%
    {}% end
}
\def\pgf@sys@svg@shading@dostops#1{%
  \edef\pgf@test{#1}%
  \ifx\pgf@test\pgfutil@empty%
  \else%
    \expandafter\pgf@sys@svg@shading@dostop\pgf@test%
    \expandafter\pgf@sys@svg@shading@dostops%
  \fi%
}
\def\pgf@sys@svg@shading@dostop#1#2#3#4{%
  % #1 start pos
  % #2 end pos
  % #3 start rgb
  % #4 end rgb
  \pgf@sys@svg@addtostops{<stop offset="}%
  \pgf@x=#1%
  \pgf@x=16\pgf@x%
  \divide\pgf@x by \c@pgf@counta\relax%
  \pgf@sys@svg@addtostops{\pgf@sys@tonumber\pgf@x" stop-color="}%
  \pgf@sys@svg@shading@dorgb#3%
  \pgf@sys@svg@addtostops{"/>\noexpand\pgfsys@svg@newline}%
}
\def\pgf@sys@svg@shading@dorgb#1#2#3{%
  \pgf@sys@svg@color@rgb#1,#2,#3\relax%
  \pgf@sys@svg@addtostops{\pgf@sys@svg@prepared}%
}

\let\pgf@sys@svg@thestops=\pgfutil@empty
\def\pgf@sys@svg@addtostops#1{%
  \edef\pgf@temp{#1}%
  \expandafter\expandafter\expandafter\def
  \expandafter\expandafter\expandafter\pgf@sys@svg@thestops
  \expandafter\expandafter\expandafter{\expandafter\pgf@sys@svg@thestops\expandafter\space\pgf@temp}%
}


\def\pgfsys@horishading#1#2#3{%
  {%
    \pgf@parsefunc{#3}%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgf@sys@svg@addtostops{<linearGradient id="pgfsh\the\pgf@sys@svg@objectcount">\noexpand\pgfsys@svg@newline}
    \pgf@sys@svg@shading@stops%
    \pgf@sys@svg@addtostops{</linearGradient>\noexpand\pgfsys@svg@newline}%
    \pgf@process{\pgfpoint{\pgf@sys@shading@end@pos}{#2}}%
    \expandafter\xdef\csname @pgfshading#1!\endcsname{%
      \def\noexpand\pgf@sys@svg@sh@defs{\noexpand\pgfsysprotocol@literal{\pgf@sys@svg@thestops}}%
      \def\noexpand\pgf@sys@svg@sh{\noexpand\pgfsysprotocol@literal{<rect
        width="\pgf@sys@tonumber{\pgf@x}"
        height="\pgf@sys@tonumber{\pgf@y}"
        style="fill:url(\noexpand\#pgfsh\the\pgf@sys@svg@objectcount);
          stroke:none"/>\noexpand\pgfsys@svg@newline}}%
      \def\noexpand\pgf@sys@svg@pos{\noexpand\pgfpoint{\the\pgf@x}{\the\pgf@y}}%
    }%
  }%
}

\def\pgfsys@functionalshading#1#2#3#4{%
  \pgf@sys@fail{functional shadings}%
  \expandafter\gdef\csname @pgfshading#1!\endcsname{%
    \let\pgf@sys@svg@sh@defs\relax%
    \let\pgf@sys@svg@sh\relax%
    \let\pgf@sys@svg@pos\pgfpointorigin%
  }%
}

\def\pgfsys@vertshading#1#2#3{%
  {%
    \pgf@parsefunc{#3}%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgf@sys@svg@addtostops{<linearGradient
      id="pgfsh\the\pgf@sys@svg@objectcount"
      gradientTransform="rotate(90)">\noexpand\pgfsys@svg@newline}
    \pgf@sys@svg@shading@stops%
    \pgf@sys@svg@addtostops{</linearGradient>\noexpand\pgfsys@svg@newline}%
    \pgf@process{\pgfpoint{\pgf@sys@shading@end@pos}{#2}}%
    \expandafter\xdef\csname @pgfshading#1!\endcsname{%
      \def\noexpand\pgf@sys@svg@sh@defs{\noexpand\pgfsysprotocol@literal{\pgf@sys@svg@thestops}}%
      \def\noexpand\pgf@sys@svg@sh{\noexpand\pgfsysprotocol@literal{<rect
        width="\pgf@sys@tonumber{\pgf@y}"
        height="\pgf@sys@tonumber{\pgf@x}"
        style="fill:url(\noexpand\#pgfsh\the\pgf@sys@svg@objectcount);
          stroke:none"/>\noexpand\pgfsys@svg@newline}}%
      \def\noexpand\pgf@sys@svg@pos{\noexpand\pgfpoint{\the\pgf@y}{\the\pgf@x}}%
    }%
  }%
}

\def\pgfsys@radialshading#1#2#3{%
  {%
    \pgf@parsefunc{#3}%
    \pgf@x=\pgf@sys@shading@end@pos\relax%
    \c@pgf@counta=\pgf@x\relax%
    \divide\c@pgf@counta by4096\relax%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgf@process{#2}%
    % Divide by 2\pgf@sys@shading@end@pos%
    \pgf@x=8\pgf@x%
    \divide\pgf@x by \c@pgf@counta\relax%
    \pgf@y=8\pgf@y%
    \divide\pgf@y by \c@pgf@counta\relax%
    \advance\pgf@x by.5pt%
    \advance\pgf@y by.5pt%
    \pgf@sys@svg@addtostops{<radialGradient
      id="pgfsh\the\pgf@sys@svg@objectcount"
      fx="\pgf@sys@tonumber\pgf@x"
      fy="\pgf@sys@tonumber\pgf@y"
      >\noexpand\pgfsys@svg@newline}
    \pgf@sys@svg@shading@stops%
    \pgf@sys@svg@addtostops{</radialGradient>\noexpand\pgfsys@svg@newline}%
    \pgf@xa=\pgf@sys@shading@end@pos%
    \pgf@xb=2\pgf@xa%    
    \expandafter\xdef\csname @pgfshading#1!\endcsname{%
      \def\noexpand\pgf@sys@svg@sh@defs{\noexpand\pgfsysprotocol@literal{\pgf@sys@svg@thestops}}%
      \def\noexpand\pgf@sys@svg@sh{\noexpand\pgfsysprotocol@literal{<circle
        cx="\pgf@sys@tonumber{\pgf@xa}"
        cy="\pgf@sys@tonumber{\pgf@xa}"
        r="\pgf@sys@tonumber{\pgf@xa}"
        style="fill:url(\noexpand\#pgfsh\the\pgf@sys@svg@objectcount);
          stroke:none"/>\noexpand\pgfsys@svg@newline}}%
      \def\noexpand\pgf@sys@svg@pos{\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@xb}}%
    }%
  }%
}


% Patterns

\def\pgfsys@declarepattern#1#2#3#4#5#6#7#8#9{%
  % Start building the pattern dictionary:
  \pgf@xa=#2\relax%
  \pgf@ya=#3\relax% 
  \pgf@xb=#4\relax%
  \pgf@yb=#5\relax%
  \pgf@xc=#6\relax%
  \pgf@yc=#7\relax%
  \ifnum#9=1\relax%
    % Colored. That's easy:
    \pgf@sys@svg@make@defs{#1}{
      <pattern
        id="pgfpat#1"
        patternUnits="userSpaceOnUse"
        width="\pgf@sys@tonumber\pgf@xc"
        height="\pgf@sys@tonumber\pgf@yc">
        #8
      </pattern>}%
  \else%
    % Uncolored. Yikes!
    \pgf@sys@svg@make@defs{#1}{
      <pattern
        id="pgfpat#1"
        patternUnits="userSpaceOnUse"
        width="\pgf@sys@tonumber\pgf@xc"
        height="\pgf@sys@tonumber\pgf@yc"/>
      <symbol id="pgfsym#1">
        #8
      </symbol>}%
  \fi%
}

\def\pgfsys@setpatternuncolored#1#2#3#4{%
  \global\advance\pgf@sys@svg@objectcount by1\relax%
  \pgf@sys@svg@color@rgb#2,#3,#4\relax%
  \pgfsysprotocol@literal{
    <pattern id="pgfupat\the\pgf@sys@svg@objectcount" xlink:href="\#pgfpat#1">
    <g stroke="\pgf@sys@svg@prepared" fill="\pgf@sys@svg@prepared"> <use xlink:href="\#pgfsym#1"/> </g>
    </pattern>}%
  \pgf@sys@svg@ref@defs{#1}%
  \pgf@sys@svg@gs@color{fill="url(\#pgfupat\the\pgf@sys@svg@objectcount)"}%
}

\def\pgfsys@setpatterncolored#1{%
  \pgf@sys@svg@ref@defs{#1}%
  \pgf@sys@svg@gs@color{fill="url(\#pgfpat#1)"}%
}






% Animation


\let\pgfsys@anim@val@dur\pgfutil@empty
\let\pgfsys@anim@val@restart\pgfutil@empty
\let\pgfsys@anim@val@repeatCount\pgfutil@empty
\let\pgfsys@anim@val@repeatDur\pgfutil@empty
\let\pgfsys@anim@val@fill\pgfutil@empty
\let\pgfsys@anim@val@keyTimes\pgfutil@empty
\let\pgfsys@anim@val@keyPoints\pgfutil@empty
\let\pgfsys@anim@val@keySplines\pgfutil@empty
\let\pgfsys@anim@val@begin\pgfutil@empty
\let\pgfsys@anim@val@end\pgfutil@empty
\let\pgfsys@anim@val@additive\pgfutil@empty
\let\pgfsys@anim@val@accumulate\pgfutil@empty
\def\pgfsys@anim@val@calcMode{spline}
\let\pgfsys@anim@val@from\pgfutil@empty
\let\pgfsys@anim@val@to\pgfutil@empty
\let\pgfsys@anim@val@by\pgfutil@empty
\let\pgfsys@anim@val@path\pgfutil@empty
\let\pgfsys@anim@val@rotate\pgfutil@empty
\let\pgfsys@anim@val@values\pgfutil@empty
\def\pgfsys@anim@val@canvas@trans{{}{}}
\let\pgfsys@anim@val@@id\pgfutil@empty
\let\pgfsys@anim@val@@type\pgfutil@empty
\expandafter\let\csname pgfsys@anim@val@xlink:href\endcsname\pgfutil@empty

\def\pgf@sys@svg@key#1{%
  \expandafter\ifx\csname pgfsys@anim@val@#1\endcsname\pgfutil@empty\else%
  \space#1="\csname pgfsys@anim@val@#1\endcsname"%
  \fi%
}

\def\pgf@svg@anim@keys{
  \pgf@sys@svg@key{dur}%
  \pgf@sys@svg@key{restart}%
  \pgf@sys@svg@key{repeatCount}%
  \pgf@sys@svg@key{repeatDur}%
  \pgf@sys@svg@key{fill}%
  \pgf@sys@svg@key{keyTimes}%
  \pgf@sys@svg@key{keyPoints}%
  \pgf@sys@svg@key{keySplines}%
  \pgf@sys@svg@key{begin}%
  \pgf@sys@svg@key{end}%
  \pgf@sys@svg@key{additive}%
  \pgf@sys@svg@key{accumulate}%
  \pgf@sys@svg@key{calcMode}%
  \pgf@sys@svg@key{values}%
  \pgf@sys@svg@key{from}%
  \pgf@sys@svg@key{to}%
  \pgf@sys@svg@key{path}%
  \pgf@sys@svg@key{rotate}%
  \pgf@sys@svg@key{xlink:href}%
}

\newif\ifpgf@sys@at@least@one@event
\def\pgf@sys@svg@do@events#1{%
  \pgf@sys@at@least@one@eventfalse%
  \def\pgf@sys@event@target{#1}%
  \expandafter\expandafter\expandafter\pgf@sys@svg@do@events@now\csname pgf@sys@event@list@#1\endcsname\relax%
}
\def\pgf@sys@svg@do@events@now{%
  \pgfutil@ifnextchar\relax{}{\pgf@sys@svg@do@event}%
}
\def\pgf@sys@svg@do@event#1#2#3#4{%
  \pgf@sys@at@least@one@eventtrue%
  % 
  {%
    \edef\pgf@temp{#1}%
    \ifx\pgf@temp\pgfutil@empty%
    \else%
      \def\pgf@temp{\pgfsys@id@ref{#1}{#2}.}%
    \fi%
    \edef\pgf@@temp{#4}%
    \ifx\pgf@@temp\pgfutil@empty%
      \pgf@x0pt%
    \else%
      \pgf@x#4pt%
    \fi%
    \ifx\pgf@sys@event@target\pgf@sys@begin@text%
      \advance\pgf@x by\pgf@xa\relax%
    \fi\relax%
    \ifdim\pgf@x<0pt%
      \edef\pgf@@temp{ \pgf@sys@tonumber\pgf@x s}%
    \else
      \edef\pgf@@temp{ +\pgf@sys@tonumber\pgf@x s}%
    \fi%
    \xdef\pgf@svg@anim@temp{\pgf@temp#3\pgf@@temp}%
  }%  
  \pgf@sys@svg@append{\pgf@sys@event@target}{\pgf@svg@anim@temp}%
  \global\let\pgf@svg@anim@temp\relax%
  \pgf@sys@svg@do@events@now%
}


\newif\ifpgf@sys@svg@is@sync@base
\def\pgf@sys@svg@anim#1#2{%
  \ifx\pgfsys@anim@val@@id\pgfutil@empty%
    \pgferror{Animation misses ``whom''}%
  \else%
  {%
    \pgf@sys@svg@tl@eval%
    \pgf@sys@svg@do@events{begin}%
    \ifpgf@sys@at@least@one@event%
    \else%
      \pgf@sys@svg@append{begin}{\ifdim\pgf@xa>0pt+\fi\pgf@sys@tonumber\pgf@xa s}%
    \fi%
    \pgf@sys@svg@do@events{end}%
    #2%
    \edef\pgf@temp{{<#1\pgfsys@if@fresh@currentid{ id="\pgfsys@id@refcurrent"}{}\pgf@svg@anim@keys/>\pgfsys@svg@newline}}%
    \expandafter\pgfsysprotocol@literal\pgf@temp%    
    \pgfsys@invalidate@currentid%
  }%
  \fi%
}

\def\pgf@sys@svg@anim@trans#1#2{%
  \ifx\pgfsys@anim@val@@id\pgfutil@empty%
    \pgferror{Animation misses ``whom''}%
  \else%
  {%
    % 
    \pgf@sys@svg@tl@eval%
    \pgf@sys@svg@do@events{begin}%
    \ifpgf@sys@at@least@one@event%
    \else%
      \pgf@sys@svg@append{begin}{\ifdim\pgf@xa>0pt+\fi\pgf@sys@tonumber\pgf@xa s}%
    \fi%
    \pgf@sys@svg@do@events{end}%
    #2%
    \pgf@sys@svg@replace{xlink:href}{\#\pgfsys@id@ref{\pgfsys@anim@val@@id}{\pgfsys@anim@val@@type-canvas}}%
    \pgfsysprotocol@literal{<#1\pgfsys@if@fresh@currentid{ id="\pgfsys@id@refcurrent"}{}\pgf@svg@anim@keys/>\pgfsys@svg@newline}%
    \pgfsys@invalidate@currentid%
    \edef\pgf@temp{{\pgfsys@id@ref{\pgfsys@anim@val@@id}{\pgfsys@anim@val@@type-canvas}}}%
    \expandafter\expandafter\expandafter\pgf@sys@attacher\expandafter\pgf@temp\pgfsys@anim@val@canvas@trans%
  }%
  \fi%
}

\newif\ifpgf@sys@svg@called
\def\pgf@sys@attacher#1#2#3{%
  \toks0{%
    {%
      \let\pgfsys@transformcm\pgfsys@anim@transformcm%
      \global\pgf@sys@svg@calledfalse%
      #2%
      \ifpgf@sys@svg@called\else\pgfsysprotocol@literal{<g>}\fi%
      \pgfsysprotocol@literal{<g id="#1">}
      {%
        \global\pgf@sys@svg@calledfalse%
        #3%
        \ifpgf@sys@svg@called\else\pgfsysprotocol@literal{<g>}\fi%
      }%
    }%
  }%
  \edef\pgf@sys@svg@beg{\expandafter\noexpand\csname pgf@sys@svg@once@beg@\pgfsys@anim@val@@id\pgfsys@anim@val@@type\endcsname}%
  \edef\pgf@sys@svg@end{\expandafter\noexpand\csname pgf@sys@svg@once@end@\pgfsys@anim@val@@id\pgfsys@anim@val@@type\endcsname}%
  \expandafter\xdef\pgf@sys@svg@beg{%
    \global\let\expandafter\noexpand\pgf@sys@svg@beg\relax% once
    \the\toks0%
  }%
  \expandafter\xdef\pgf@sys@svg@end{%
    \global\let\expandafter\noexpand\pgf@sys@svg@end\relax% once
    \noexpand\pgfsysprotocol@literal{</g> </g> </g> \noexpand\pgfsys@svg@newline}%
  }%
  \expandafter\expandafter\expandafter\pgfsys@attach@to@id%
  \expandafter\expandafter\expandafter\pgfsys@anim@val@@id%
  \expandafter\expandafter\expandafter\pgfsys@anim@val@@type%
  \expandafter\expandafter\expandafter{\expandafter\pgf@sys@svg@beg\expandafter}\expandafter{\pgf@sys@svg@end}{}%
}

\newif\ifpgf@sys@svg@staged

\def\pgfsys@anim@transformcm#1#2#3#4#5#6{%
  \ifpgf@sys@svg@called%
    \pgferror{Double transformation calls in animation}%
  \else%
    {%
      \pgf@x=#5\pgf@y=#6%
      \edef\pgf@temp{ transform="matrix(#1,#2,#3,#4,\pgf@sys@tonumber{\pgf@x},\pgf@sys@tonumber{\pgf@y})"}%
      \ifx\pgf@temp\pgf@sys@svg@idmat@text%
        \let\pgf@temp\pgfutil@empty%
      \fi%
      \pgfsysprotocol@literal{<g\pgf@temp>\pgfsys@svg@newline}%
    }%
    \global\pgf@sys@svg@calledtrue%
  \fi%
}
\def\pgf@sys@svg@idmat@text{ transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"}

\def\pgf@sys@svg@replace#1#2{%
  \expandafter\edef\csname pgfsys@anim@val@#1\endcsname{#2}%
}

\def\pgf@sys@svg@append#1#2{%
  \expandafter\let\expandafter\pgf@svg@anim@temp@\csname pgfsys@anim@val@#1\endcsname%
  \ifx\pgf@svg@anim@temp@\pgfutil@empty%
    \expandafter\edef\csname pgfsys@anim@val@#1\endcsname{#2}%
  \else\ifx\pgf@svg@anim@temp@\relax%
    \pgfutil@packageerror{pgfsys}{Unknown animation key '#1'}{}
  \else%
    \edef\pgf@svg@anim@temp@{\pgf@svg@anim@temp@;#2}%
    \expandafter\let\csname pgfsys@anim@val@#1\endcsname\pgf@svg@anim@temp@%
  \fi\fi%  
}

% The actual animate command
\def\pgfsys@animate#1{%
  \expandafter\let\expandafter\pgf@sys@temp\csname pgfsys@svg@animate#1\endcsname\relax%
  \ifx\pgf@sys@temp\relax%
    \pgf@sys@fail{animation attribute #1}%
  \else%
    \pgf@sys@temp%
  \fi%
}

\def\pgfsys@svg@animatestage{\pgf@sys@svg@anim{animate
    attributeName="visibility"}{%
    \pgfsys@attach@to@id\pgfsys@anim@val@@id\pgfsys@anim@val@@type{}{}\pgf@sys@svg@stagedtrue}%
}

% The non-transforming animations
\def\pgfsys@svg@animateopacity{\pgf@sys@svg@anim{animate attributeName="opacity"}{}}
\def\pgfsys@svg@animatefillopacity{\pgf@sys@svg@anim{animate attributeName="fill-opacity"}{}}
\def\pgfsys@svg@animatestrokeopacity{\pgf@sys@svg@anim{animate attributeName="stroke-opacity"}{}}
\def\pgfsys@svg@animatevisibility{\pgf@sys@svg@anim{animate attributeName="visibility"}{}}
\def\pgfsys@svg@animatelinewidth{\pgf@sys@svg@anim{animate attributeName="stroke-width"}{}}
\def\pgfsys@svg@animatefillcolor{\pgf@sys@svg@anim{animate attributeName="fill"}{}}
\def\pgfsys@svg@animatestrokecolor{\pgf@sys@svg@anim{animate attributeName="stroke"}{}}
\def\pgfsys@svg@animateviewbox{\pgf@sys@svg@anim{animate attributeName="viewBox"}{}}
\def\pgfsys@svg@animatepath{\pgf@sys@svg@anim{animate attributeName="d"}{}}
\def\pgfsys@svg@animatedashphase{\pgf@sys@svg@anim{animate attributeName="stroke-dashoffset"}{}}
\def\pgfsys@svg@animatedashpattern{\pgf@sys@svg@anim{animate attributeName="stroke-dasharray"}{}}
\def\pgfsys@svg@animatesyncbase{{\pgf@sys@svg@is@sync@basetrue\pgf@sys@svg@anim{animate}{}}}

% The transforming animations
\def\pgfsys@svg@animatetranslate{\pgf@sys@svg@anim@trans{animateTransform attributeName="transform" type="translate"}{}}
\def\pgfsys@svg@animatescale{\pgf@sys@svg@anim@trans{animateTransform attributeName="transform" type="scale"}{}}
\def\pgfsys@svg@animaterotate{\pgf@sys@svg@anim@trans{animateTransform attributeName="transform" type="rotate"}{}}
\def\pgfsys@svg@animateskewx{\pgf@sys@svg@anim@trans{animateTransform attributeName="transform" type="skewX"}{}}
\def\pgfsys@svg@animateskewy{\pgf@sys@svg@anim@trans{animateTransform attributeName="transform" type="skewY"}{}}
\def\pgfsys@svg@animatemotion{\pgf@sys@svg@anim@trans{animateMotion}{%
    \let\pgfsys@anim@val@keyPoints\pgfsys@anim@val@values%
    \let\pgfsys@anim@val@values\pgfutil@empty%
    \ifx\pgfsys@anim@val@keyTimes\pgfutil@empty%
      \let\pgfsys@anim@val@keyPoints\pgfutil@empty%
    \fi%
  }}

% The keys
\def\pgfsys@animation@whom#1#2{%
  % Animations must "look forward"...
  \pgfsys@if@fresh@id{#1}{#2}{}{\pgferror{Animations must precede the to-be-animated objects (``whom'')}}%
  \pgf@sys@svg@replace{@id}{#1}%
  \pgfsys@clean@type\pgf@sys@svg@temp{#2}%
  \pgf@sys@svg@replace{@type}{\pgf@sys@svg@temp}%
  \pgf@sys@svg@replace{xlink:href}{\#\pgfsys@id@ref{#1}{\pgf@sys@svg@temp}}%
}
\def\pgfsys@animation@restart@always{\pgf@sys@svg@replace{restart}{always}}
\def\pgfsys@animation@restart@never{\pgf@sys@svg@replace{restart}{never}}
\def\pgfsys@animation@restart@whennotactive{\pgf@sys@svg@replace{restart}{whenNotActive}}
\def\pgfsys@animation@repeat@indefinite{\pgf@sys@svg@replace{repeatCount}{indefinite}}
\def\pgfsys@animation@repeat#1{\pgf@sys@svg@replace{repeatCount}{#1}}
\def\pgfsys@animation@repeat@dur#1{\pgf@sys@svg@replace{repeatDur}{#1}}
\def\pgfsys@animation@freezeatend{\pgf@sys@svg@replace{fill}{freeze}}
\def\pgfsys@animation@removeatend{\pgf@sys@svg@replace{fill}{remove}}
\def\pgfsys@animation@canvas@transform#1#2{\def\pgfsys@anim@val@canvas@trans{{#1}{#2}}}
\def\pgfsys@animation@offset#1#2{\pgfsys@animation@event{}{}{}{#1}{#2}}
\def\pgfsys@animation@event#1#2#3#4#5{%
  \expandafter\edef\csname pgf@sys@event@list@#5\endcsname{\csname pgf@sys@event@list@#5\endcsname{#1}{#2}{#3}{#4}}%
}%
\def\pgf@sys@event@list@begin{}
\def\pgf@sys@event@list@end{}
\def\pgfsys@animation@syncbegin#1#2#3#4{\pgfsys@animation@event{#1}{#2}{begin}{#3}{#4}}
\def\pgfsys@animation@syncend#1#2#3#4{\pgfsys@animation@event{#1}{#2}{end}{#3}{#4}}
\def\pgfsys@animation@repeat@event#1#2#3#4#5{\pgfsys@animation@event{#1}{#2}{repeat(#3)}{#4}{#5}}
\def\pgfsys@animation@accesskey#1#2#3{\pgfsys@animation@event{}{}{accessKey(#1)}{#2}{#3}}
\def\pgfsys@animation@sum{\pgf@sys@svg@replace{additive}{sum}}
\def\pgfsys@animation@replace{\pgf@sys@svg@replace{additive}{replace}}
\def\pgfsys@animation@accumulate{\pgf@sys@svg@replace{accumulate}{sum}}
\def\pgfsys@animation@noaccumulate{\pgf@sys@svg@replace{accumulate}{}}
\def\pgfsys@animation@rotatealong{\pgf@sys@svg@replace{rotate}{auto}}
\def\pgfsys@animation@norotatealong{\pgf@sys@svg@replace{rotate}{}}
\def\pgfsys@animation@movealong#1{%
  {%
    \let\pgf@sys@save@svgpath=\pgf@sys@svgpath%
    \global\let\pgf@sys@svgpath=\pgfutil@empty%
    \pgfsyssoftpath@getcurrentpath\pgf@sys@save@path%
    \pgfsyssoftpath@setcurrentpath\pgfutil@empty%
    #1%
    \pgfsyssoftpath@invokecurrentpath%
    \pgfsyssoftpath@setcurrentpath\pgf@sys@save@path%
    \global\let\pgf@svg@anim@temp\pgf@sys@svgpath%
    \global\let\pgf@sys@svgpath\pgf@sys@save@svgpath%
  }%
  \pgf@sys@svg@replace{path}{\pgf@svg@anim@temp}%
}

% Timelines
\let\pgf@sys@svg@tl@entries\pgfutil@empty
\let\pgf@sys@svg@tl@start\pgfutil@empty
\let\pgf@sys@svg@tl@end\pgfutil@empty

\let\pgf@sys@svg@tl@explicit@start\pgfutil@empty
\let\pgf@sys@svg@tl@explicit@end\pgfutil@empty

\def\pgfsys@animation@paced#1#2{\def\pgf@sys@svg@tl@explicit@start{#1}\def\pgf@sys@svg@tl@explicit@end{#2}\pgf@sys@svg@replace{calcMode}{paced}}
\def\pgfsys@animation@spline{%
  \let\pgf@sys@svg@tl@explicit@start\pgfutil@empty
  \let\pgf@sys@svg@tl@explicit@end\pgfutil@empty%
  \pgf@sys@svg@replace{calcMode}{spline}
}

\def\pgfsys@animation@time#1#2#3#4#5{%
  \def\pgf@sys@svg@t{#1}%
  \let\pgf@sys@last@out@spline\pgf@sys@svg@out@spline%
  \def\pgf@sys@svg@in@spline{{#2}{#3}}%
  \def\pgf@sys@svg@out@spline{{#4}{#5}}%
}

\def\pgf@sys@svg@entry#1{%
  \ifx\pgf@sys@svg@tl@start\pgfutil@empty%
    % Ah, first.
    \let\pgf@sys@svg@tl@start\pgf@sys@svg@t%
    \edef\pgf@sys@svg@tl@entries{%
      \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
      \noexpand\pgf@sys@svg@add@value{#1}%
    }%
  \else%
    \ifx\pgf@sys@last@out@spline\pgfsys@stay@text%
      \ifx\pgf@sys@svg@in@spline\pgfsys@jump@text%
        {%
          \pgf@x\pgf@sys@svg@t pt
          \pgf@xa\pgf@sys@svg@tl@end pt%
          \advance\pgf@x by\pgf@xa%
          \pgf@x.5\pgf@x%
          \edef\pgf@sys@temp{\pgf@sys@tonumber\pgf@x}
        \expandafter}\expandafter\def\expandafter\pgf@sys@temp\expandafter{\pgf@sys@temp}%
        \edef\pgf@sys@svg@temp{%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@temp}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{\pgf@sys@svg@last@value}%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@temp}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{#1}%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{#1}%
        }%
      \else
        \edef\pgf@sys@svg@temp{%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{\pgf@sys@svg@last@value}%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{#1}%
        }%
      \fi%
    \else%
      \ifx\pgf@sys@svg@in@spline\pgfsys@jump@text%
        \edef\pgf@sys@svg@temp{%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@tl@end}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{#1}%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
          \noexpand\pgf@sys@svg@add@spline{0}{0}{1}{1}%
          \noexpand\pgf@sys@svg@add@value{#1}%
        }%
      \else%
        \edef\pgf@sys@svg@temp{%
          \noexpand\pgf@sys@svg@add@time{\pgf@sys@svg@t}%
          \noexpand\pgf@sys@svg@add@spline\pgf@sys@last@out@spline\pgf@sys@svg@in@spline%
          \noexpand\pgf@sys@svg@add@value{#1}%
        }%
      \fi%
    \fi%
    \expandafter\expandafter\expandafter\def%
    \expandafter\expandafter\expandafter\pgf@sys@svg@tl@entries%
    \expandafter\expandafter\expandafter{\expandafter\pgf@sys@svg@tl@entries\pgf@sys@svg@temp}%
  \fi%  
  \let\pgf@sys@svg@tl@end\pgf@sys@svg@t%
  \edef\pgf@sys@svg@last@value{#1}%
}
\newif\ifpgf@sys@svg@do@times
\def\pgf@sys@svg@tl@eval{%
  \pgf@xa=0pt%
  % Overrulings
  \pgf@sys@svg@do@timestrue%
  \ifx\pgf@sys@svg@tl@explicit@start\pgfutil@empty\else\let\pgf@sys@svg@tl@start\pgf@sys@svg@tl@explicit@start\pgf@sys@svg@do@timesfalse\fi%
  \ifx\pgf@sys@svg@tl@explicit@end\pgfutil@empty\else\let\pgf@sys@svg@tl@end\pgf@sys@svg@tl@explicit@end\pgf@sys@svg@do@timesfalse\fi%
  % Ok, we need to compute the time interval
  \ifx\pgf@sys@svg@tl@end\pgfutil@empty%
  \else%
    \ifx\pgf@sys@svg@tl@start\pgfutil@empty\else\pgf@xa=\pgf@sys@svg@tl@start pt\fi%
    \pgf@xb=\pgf@sys@svg@tl@end pt%
    \advance\pgf@xb by -\pgf@xa%
    % Ok, \pgf@xb is now the duration.
    \ifdim\pgf@xb>0pt\relax%
      \pgf@sys@svg@replace{dur}{\pgf@sys@tonumber\pgf@xb}%
    \else%
      \pgf@sys@svg@replace{dur}{\pgf@sys@svg@indefinitetext}%
    \fi%
    % Now, prepare factors
    \pgf@xc=8192pt%
    \ifdim\pgf@xb<0.0001pt\relax
      \pgf@xc=1pt%
      \pgf@xb=1sp%
    \else%
      \divide\pgf@xc by\pgf@xb%
      \multiply\pgf@xb by\pgf@xc%
      \divide\pgf@xb by65536%
    \fi%
    % Now, run!
    \pgf@sys@svg@tl@entries%
    \ifx\pgfsys@anim@val@dur\pgf@sys@svg@indefinitetext%
      \let\pgfsys@anim@val@from\pgfsys@anim@val@to%
      \let\pgfsys@anim@val@keyTimes\pgfutil@empty%
      \let\pgfsys@anim@val@calcMode\pgfutil@empty%
    \fi%
  \fi%
}
\def\pgf@sys@svg@indefinitetext{indefinite}
\def\pgf@sys@svg@add@time#1{%
  \ifpgf@sys@svg@do@times%
    % Compute fraction:
    \pgf@yb=#1pt%
    \advance\pgf@yb by-\pgf@xa%
    \multiply\pgf@yb by\pgf@xc%
    \divide\pgf@yb by\pgf@xb%
    \ifdim\pgf@yb<0pt\pgf@yb=0pt\fi%
    \ifdim\pgf@yb>1pt\pgf@yb=1pt\fi%
    \pgf@sys@svg@append{keyTimes}{\pgf@sys@tonumber\pgf@yb}%
  \fi%
}
\def\pgf@sys@svg@add@spline#1#2#3#4{\ifpgf@sys@svg@do@times\pgf@sys@svg@append{keySplines}{#1 #2 #3 #4}\fi}
\def\pgf@sys@svg@add@value#1{%
  \ifx\pgfsys@anim@val@values\pgfutil@empty%
    \ifx\pgfsys@anim@val@to\pgfutil@empty%
      \pgf@sys@svg@replace{to}{#1}%
    \else% move
      \let\pgfsys@anim@val@values\pgfsys@anim@val@to%
      \let\pgfsys@anim@val@to\pgfutil@empty%
      \pgf@sys@svg@append{values}{#1}%
    \fi%
  \else%
    \pgf@sys@svg@append{values}{#1}%
  \fi%
}
\def\pgfsys@animation@val@current{\pgf@sys@svg@entry{}}
\def\pgfsys@animation@val{\pgf@sys@svg@entry{nil}} % will be ignored anyway
\def\pgfsys@animation@val@text#1{\pgf@sys@svg@entry{#1}}
\def\pgfsys@animation@val@scalar#1{\pgf@sys@svg@entry{#1}}
\def\pgfsys@animation@val@dimension#1{%
  {%
    \pgf@x=#1\relax%
    \xdef\pgf@svg@anim@temp{\expandafter\Pgf@geT\the\pgf@x}%
  }%
  \pgf@sys@svg@entry{\pgf@svg@anim@temp}%
}
\def\pgfsys@animation@val@color@rgb#1#2#3{\pgf@sys@svg@color@rgb#1,#2,#3\relax\pgf@sys@svg@entry{\pgf@sys@svg@prepared}}
\def\pgfsys@animation@val@color@cmyk#1#2#3#4{\pgf@sys@svg@color@cmyk#1,#2,#3,#4\relax\pgf@sys@svg@entry{\pgf@sys@svg@prepared}}
\def\pgfsys@animation@val@color@cmy#1#2#3{\pgf@sys@svg@color@cmy#1,#2,#3\relax\pgf@sys@svg@entry{\pgf@sys@svg@prepared}}
\def\pgfsys@animation@val@color@gray#1{\pgf@sys@svg@color@gray#1\relax\pgf@sys@svg@entry{\pgf@sys@svg@prepared}}
\def\pgfsys@animation@val@path#1{%
  {%
    \let\pgf@sys@save@svgpath=\pgf@sys@svgpath%
    \global\let\pgf@sys@svgpath=\pgfutil@empty%
    \pgfsyssoftpath@getcurrentpath\pgf@sys@save@path%
    \pgfsyssoftpath@setcurrentpath\pgfutil@empty%
    #1%
    \pgfsyssoftpath@invokecurrentpath%
    \pgfsyssoftpath@setcurrentpath\pgf@sys@save@path%
    \global\let\pgf@svg@anim@temp\pgf@sys@svgpath%
    \global\let\pgf@sys@svgpath\pgf@sys@save@svgpath%
  }%
  \pgf@sys@svg@entry{\pgf@svg@anim@temp}%
}
\def\pgfsys@animation@val@translate#1#2{%
  {%
    \pgf@x=#1\relax%
    \pgf@y=#2\relax%
    \xdef\pgf@svg@anim@temp{\expandafter\Pgf@geT\the\pgf@x\space\expandafter\Pgf@geT\the\pgf@y}%
  }%
  \pgf@sys@svg@entry{\pgf@svg@anim@temp}%
}
\def\pgfsys@animation@val@scale#1#2{\pgf@sys@svg@entry{#1 #2}}
\def\pgfsys@animation@val@viewbox#1#2#3#4{%
  {%
    \pgf@x=#1\relax%
    \pgf@y=#2\relax%
    \pgf@xa=#3\relax%
    \pgf@ya=#4\relax%
    \advance\pgf@xa by-\pgf@x%
    \advance\pgf@ya by-\pgf@y%
    \xdef\pgf@svg@anim@temp{\expandafter\Pgf@geT\the\pgf@x\space\expandafter\Pgf@geT\the\pgf@y\space\expandafter\Pgf@geT\the\pgf@xa\space\expandafter\Pgf@geT\the\pgf@ya}%
  }%
  \pgf@sys@svg@entry{\pgf@svg@anim@temp}%
}
\def\pgfsys@animation@val@dashpattern#1{%
  \edef\pgf@test@dashpattern{#1}%
  \let\pgf@sys@svg@parsed@dash\pgfutil@empty%
  \expandafter\pgf@sys@svg@parse@dash\pgf@test@dashpattern,\relax%
  \pgf@sys@svg@entry{\pgf@sys@svg@parsed@dash}%
}



%

\def\pgfutil@color{\pgfsetcolor}

\endinput


%%% Local Variables: 
%%% mode: latex
%%% End: 
