% Copyright 2016 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/frontendlayer/tikz/libraries/tikzlibraryanimations.code.tex,v 1.19 2015/12/28 13:19:07 tantau Exp $

\usepgfmodule{animations}

\def\tikzanimationsset{\pgfqkeys{/tikz/animations}}

%
% The parsers
%

\def\tikz@anim@simple@parse#1{\def\tikz@anim@result{#1}}

\def\tikz@anim@slant@parse#1{\pgfmathsetmacro\tikz@anim@result{atan(#1)}}

\def\tikz@anim@dashpattern@parse#1{%
  \def\tikz@dashpattern{}%
  \expandafter\tikz@scandashon\pgfutil@gobble#1o\@nil%
  \expandafter\tikz@addoption\expandafter{\expandafter\pgfsetdash\tikz@temp}%
  \let\tikz@anim@result\tikz@dashpattern%
}

\def\tikz@anim@xshift@parse#1{\pgfmathparse{#1}\edef\tikz@anim@result{\noexpand\pgfqpoint{\pgfmathresult pt}{0pt}}}
\def\tikz@anim@yshift@parse#1{\pgfmathparse{#1}\edef\tikz@anim@result{\noexpand\pgfqpoint{0pt}{\pgfmathresult pt}}}

\def\tikz@anim@shift@parse#1{\tikz@scan@one@point\tikz@anim@do@shift#1}
\def\tikz@anim@do@shift#1{\def\tikz@anim@result{#1}}


\def\tikz@anim@view@parse#1{\tikz@anim@view@parse@#1\pgf@stop}%
\def\tikz@anim@view@parse@{%
  \pgfutil@ifnextchar({\tikz@scan@one@point\tikz@anim@view@parse@a}{\tikz@anim@view@node}%
}
\def\tikz@anim@view@parse@a#1{%
  \def\tikz@anim@result{{#1}}%
  \pgfutil@ifnextchar r{\tikz@anim@view@parsed@rec}{\tikz@scan@one@point\tikz@anim@view@parse@b}%
}
\def\tikz@anim@view@parsed@rec rectangle{\tikz@scan@one@point\tikz@anim@view@parse@b}%
\def\tikz@anim@view@parse@b#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@anim@result{#1}}%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{\tikzerror{Wrong view syntax}}%
}
\def\tikz@anim@view@node#1\pgf@stop{%
  \expandafter\ifx\csname pgf@sh@ns@#1\endcsname\relax%
    \tikzerror{Undefined node '#1'}%
  \else%
    % Compute a bounding box for the node:
    {%
      \pgf@process{\pgfpointanchor{#1}{west}}%
      \pgf@xa\pgf@x \pgf@ya\pgf@y
      \pgf@xb\pgf@x \pgf@yb\pgf@y
      \pgf@process{\pgfpointanchor{#1}{north}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{south}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{east}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%
      \xdef\tikz@anim@result{{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}{\noexpand\pgfqpoint{\the\pgf@xb}{\the\pgf@yb}}}
    }%
  \fi%
}

\def\tikz@anim@path@parse#1{%
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \expandafter\tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@result%
        \pgfprocessround{\tikz@anim@result}{\tikz@anim@result}%
        \global\let\tikz@anim@result\tikz@anim@result%
        \endpgfinterruptpath%
      }}%
  }%
}



% The special along parser

\def\tikz@anim@along#1{%
  % Parse the path...
  {%
    \setbox0=\hbox{{% protect against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@parsed@path%
        \pgfprocessround{\tikz@anim@parsed@path}{\tikz@anim@parsed@path}%
        \global\let\tikz@anim@parsed@path\tikz@anim@parsed@path%
        \endpgfinterruptpath%
      }}%
  }%
  \pgfanimationset{along softpath=\tikz@anim@parsed@path}%
}

\def\tikz@anim@parse@origin#1{%
  \tikz@scan@one@point\tikz@anim@parse@origin@#1\relax%
}
\def\tikz@anim@parse@origin@#1{\pgfkeys{/pgf/animation/origin={#1}}}





% Each (full) timeline entry is of the form
%
% objects:attributes<options>value
%
%

\def\tikz@animation@syntax@check#1#2{%
  \def\tikz@animation@rest{#1}%
  \expandafter\pgfutil@in@\expandafter:\expandafter{\tikz@key}%
  \ifpgfutil@in@%
    \expandafter\tikz@anim@parse@colon\tikz@key\pgf@stop%
  \else%
    \expandafter\tikz@animation@syntax@check@b\tikz@key\pgf@stop{#2}%
  \fi%
}

\def\tikz@animation@syntax@check@b{%
  \pgfutil@ifnextchar<{\tikz@animation@parse@options}{\tikz@animation@error}%
}

\def\tikz@animation@error#1\pgf@stop#2{%
  #2%
}

\def\tikz@anim@parse@colon#1:#2\pgf@stop{%
  \begingroup
    \pgfkeys@spdef\tikz@anim@a{#1}%
    \ifx\tikz@anim@a\pgfutil@empty%
    \else%
      \let\tikz@anim@tl@objects\tikz@anim@a%
    \fi%
    \pgfutil@in@_{#2}%
    \ifpgfutil@in@%
      \tikz@anim@parse@under#2\pgf@stop%
    \else%
      \tikz@anim@parse@under#2_\pgf@stop%
    \fi%
    \tikz@anim@make@entry%
    \ifx\tikz@animation@rest\pgfkeysnovalue@text%
    \else%
      \expandafter\tikzset\expandafter{\tikz@animation@rest}%
    \fi%
  \endgroup%
}

\def\tikz@anim@parse@under#1_#2\pgf@stop{%
  \pgfkeys@spdef\tikz@anim@a{#1}%
  \ifx\tikz@anim@a\pgfutil@empty%
  \else%
    \let\tikz@anim@tl@attributes\tikz@anim@a%
  \fi%
  \pgfkeys@spdef\tikz@anim@a{#2}%
  \ifx\tikz@anim@a\pgfutil@empty%
  \else%
    \let\tikz@anim@tl@id\tikz@anim@a%
  \fi%
}

\def\tikz@animation@parse@options#1\pgf@stop#2{%
  \begingroup%
    \pgfkeys@spdef\tikz@anim@a{#1}%
    \ifx\tikz@anim@a\tikz@anim@empty@a%
    \else\ifx\tikz@anim@a\tikz@anim@empty@b%
    \else%
      \expandafter\expandafter\expandafter\def%
      \expandafter\expandafter\expandafter\tikz@anim@tl@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@tl@options\tikz@anim@a}%
    \fi\fi%
    \tikz@anim@make@entry%
    \ifx\tikz@animation@rest\pgfkeysnovalue@text%
    \else%
      \expandafter\tikzset\expandafter{\tikz@animation@rest}%
    \fi%
  \endgroup%
}
\def\tikz@anim@empty@a{<>}
\def\tikz@anim@empty@b{< >}

\def\tikz@anim@tl@objects{}
\def\tikz@anim@tl@attributes{}
\def\tikz@anim@tl@id{}
\def\tikz@anim@tl@options{}

\def\tikz@anim@make@entry{%
  \ifx\tikz@anim@tl@objects\pgfutil@empty%
  \else\ifx\tikz@anim@tl@attributes\pgfutil@empty%
  \else\ifx\tikz@anim@tl@options\pgfutil@empty%
  \else\foreach\tikz@anim@tl@object in\tikz@anim@tl@objects{%
    \expandafter\tikzanimationattributesset\expandafter{\tikz@anim@tl@attributes}%
  }%
  \fi\fi\fi%
}

\def\tikzanimationattributesset#1{\pgfqkeys{/tikz/animation/attributes}{#1}}

\tikzanimationattributesset{
  .unknown/.code={
    \let\tikz@anim@attribute@name\pgfkeyscurrentname
    \expandafter\let\expandafter\pgf@temp\csname tikz@anim@def@pgf@attr@\tikz@anim@attribute@name\endcsname%
    \ifx\pgf@temp\relax%
      \tikzerror{Unknown animation attribute '\tikz@anim@attribute@name'}%
    \else%
      \edef\pgf@marshal{\noexpand\tikz@timeline@entry{\tikz@anim@tl@object}{\tikz@anim@attribute@name}{\tikz@anim@tl@id}}%
      \expandafter\pgf@marshal\expandafter{\expandafter\tikz@anim@entry\tikz@anim@tl@options<>\pgf@stop}%
    \fi%
  }
}

\def\tikzanimationset{\pgfqkeys{/tikz/animation}}

\def\tikz@anim@entry{%
  % Reset splines and value:
  \let\tikz@anim@result\pgfutil@empty%
  \pgf@anim@reset@linear%
  \tikz@anim@entry@parser%
}
\def\tikz@anim@entry@parser<#1>{%
  \pgfutil@ifnextchar\pgf@stop{%
    \tikzanimationset{#1}%
    \tikz@anim@entry@done%
  }{%
    \pgfutil@ifnextchar<{%
      \tikzanimationset{#1}%
      \tikz@anim@entry@parser%
    }{%
      \pgfkeys@spdef\tikz@anim@key{#1}%
      \tikz@anim@entry@parse@val%
    }%
  }%
}
\def\tikz@anim@entry@parse@val#1<{%
  \ifx\tikz@anim@key\pgfutil@empty%
    \tikz@animation@parser{#1}%
  \else%
    \expandafter\tikzanimationset\expandafter{\tikz@anim@key={#1}}%
  \fi%
  \tikz@anim@entry@parser<%  
}
\def\tikz@anim@entry@done\pgf@stop{%
  \ifx\tikz@anim@result\pgfutil@empty%
  \else%
    \expandafter\expandafter\expandafter\pgf@anim@entry%
    \expandafter\expandafter\expandafter{\expandafter\tikz@animation@time\expandafter}\expandafter{\tikz@anim@result}%
  \fi%
}


\tikzanimationset{
  forever/.style=/pgf/animation/freeze at end,
  freeze/.style=/pgf/animation/freeze at end,
  restart/.forward to=/pgf/animation/restart,
  repeats/.forward to=/pgf/animation/repeats,
  repeats/.default=,
  repeat/.forward to=/pgf/animation/repeats,
  repeat/.default=,
  add/.forward to=/pgf/animation/add,
  replace/.forward to=/pgf/animation/replace,
  begin/.forward to=/pgf/animation/begin,
  end/.forward to=/pgf/animation/end,
  begin on/.forward to=/pgf/animation/begin on,
  end on/.forward to=/pgf/animation/end on,
  origin/.code=\tikz@anim@parse@origin{#1},
  paced/.forward to=/pgf/animation/paced,
  duration/.forward to=/pgf/animation/paced,
  along/.code=\tikz@anim@along{#1},
  v/.code=\tikz@animation@parser{#1},
  value/.style={v={#1}},
  t/.code=\pgfparsetime{#1}\let\tikz@animation@time\pgftimeresult,
  time/.style={t={#1}},
  entry control/.forward to=/pgf/animation/entry control,
  exit control/.forward to=/pgf/animation/exit control,
  stay/.forward to=/pgf/animation/stay,
  jump/.forward to=/pgf/animation/jump,
  ease/.style={
    entry control={1-(#1)}{1},
    exit control={#1}{0}
  },
  ease/.default=0.5,
  ease in/.style={
    entry control={1-(#1)}{1},
  },
  ease in/.default=0.5,
  ease out/.style={
    exit control={#1}{0},
  },
  ease out/.default=0.5,
  .unknown/.code={%
    \def\tikz@anim@unparsed@value{#1}%
    \expandafter\tikz@anim@time@test\pgfkeyscurrentname\pgf@stop%
  }
}

\def\tikz@anim@time@test#1#2\pgf@stop{%
  \edef\tikz@temp{\meaning#1}%
  \ifx\tikz@temp\tikz@anim@plus@text%
    \tikz@anim@time@plusplus#2\pgf@stop%
  \else%
    \expandafter\ifx\csname tikz@anim@test@\tikz@temp\endcsname\relax%
      \tikzerror{I do not know the timing key '#1#2' to which you passed '\tikz@anim@unparsed@value'}%
    \else%
      \pgfparsetime{#1#2}\let\tikz@animation@time\pgftimeresult%
    \fi%
  \fi%
  \ifx\tikz@anim@unparsed@value\pgfutil@empty%
  \else\ifx\tikz@anim@unparsed@value\pgfkeysnovalue@text%
  \else%
    \expandafter\tikz@animation@parser\expandafter{\tikz@anim@unparsed@value}%
  \fi\fi%
}

\edef\tikz@anim@plus@text{\meaning+}

\def\tikz@anim@time@plusplus{\pgfutil@ifnextchar+{\tikz@anim@time@plusplus@}{\tikz@anim@time@no@plus}}

\def\tikz@anim@time@no@plus#1\pgf@stop{%
  \pgfparsetime{#1}\let\tikz@animation@time\pgftimeresult%
}

\def\tikz@anim@time@plusplus@+#1\pgf@stop{%
  \pgfparsetime{#1+\tikz@animation@time}\let\tikz@animation@time\pgftimeresult%
}

\expandafter\let\csname tikz@anim@test@the character 0\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 1\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 2\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 3\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 4\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 5\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 6\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 7\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 8\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character 9\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character -\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@test@the character .\endcsname\pgfutil@empty




% Configure an animation attribute
%
% #1 = tikz attribute name
% #2 = configuration
%
% Description:
%
% Sets up internals for the tikz attribute.

\def\tikzanimationdefineattribute#1#2{%
  \expandafter\def\csname tikz@anim@def@pgf@attr@#1\endcsname{#1}
  \expandafter\let\csname tikz@anim@def@no@node@#1\endcsname\pgfutil@empty
  \expandafter\let\csname tikz@anim@def@is@node@#1\endcsname\pgfutil@empty
  \expandafter\let\csname tikz@anim@def@code@#1\endcsname\pgfutil@empty
  \expandafter\let\csname tikz@anim@def@parser@#1\endcsname\tikz@anim@simple@parse
  \def\tikz@anim@attr{#1}%
  \pgfkeys{/tikz/animation/@attrdef/.cd,#2}
}

\pgfkeys{/tikz/animation/@attrdef/.cd,
  pgf attribute name/.code=\expandafter\def\csname tikz@anim@def@pgf@attr@\tikz@anim@attr\endcsname{#1},
  scope type/.code=\expandafter\def\csname tikz@anim@def@no@node@\tikz@anim@attr\endcsname{#1},
  node type/.code=\expandafter\def\csname tikz@anim@def@is@node@\tikz@anim@attr\endcsname{#1},
  code/.code=\expandafter\def\csname tikz@anim@def@code@\tikz@anim@attr\endcsname{#1},
  parser/.code=\expandafter\edef\csname tikz@anim@def@parser@\tikz@anim@attr\endcsname{\expandafter\noexpand\csname tikz@anim@#1@parse\endcsname},
}


% Configure an animation attribute list
%
% #1 = tikz attribute list name
% #2 = list of tikz attributes
%
% Description:
%
% Sets up internals for the tikz attribute.

\def\tikzanimationdefineattributelist#1#2{%
  \tikzanimationattributesset{#1/.style={#2}}
}




% Definition of the tikz attributes

 
\tikzanimationdefineattributelist{color}{fill, draw, text}
\tikzanimationdefineattribute{dash pattern}{parser=dashpattern}
\tikzanimationdefineattribute{dash phase}{}
\tikzanimationdefineattribute{draw opacity}{pgf attribute name=stroke opacity}
\tikzanimationdefineattribute{draw}{pgf attribute name=stroke, node type=.background.path}
\tikzanimationdefineattribute{drive}{pgf attribute name=motion,code=\pgfanimationset{add,rotate along=true}}
\tikzanimationdefineattribute{fill opacity}{}
\tikzanimationdefineattribute{fill}{node type=.background.path}
\tikzanimationdefineattribute{line width}{}
\tikzanimationdefineattribute{morph}{pgf attribute name=softpath, scope type=.path, node type=.background.path, parser=path}
\tikzanimationdefineattribute{motion}{code=\pgfanimationset{add}}
\tikzanimationdefineattribute{opacity}{}
\tikzanimationdefineattribute{rotate}{code=\pgfanimationset{add}}
\tikzanimationdefineattribute{scale}{code=\pgfanimationset{add}}
\tikzanimationdefineattribute{shift}{pgf attribute name=translate, parser=shift, code=\pgfanimationset{add}}
\tikzanimationdefineattribute{stage}{}
\tikzanimationdefineattribute{text opacity}{pgf attribute name=fill opacity, node type=.text}
\tikzanimationdefineattribute{text}{pgf attribute name=fill, node type=.text}
\tikzanimationdefineattribute{view}{scope type=.view, parser=view}
\tikzanimationdefineattribute{visible}{}
\tikzanimationdefineattribute{xshift}{pgf attribute name=translate, parser=xshift, code=\pgfanimationset{add}}
\tikzanimationdefineattribute{xskew}{code=\pgfanimationset{add}}
\tikzanimationdefineattribute{xslant}{pgf attribute name=xskew, parser=slant, code=\pgfanimationset{add}}
\tikzanimationdefineattribute{yshift}{pgf attribute name=translate, parser=yshift, code=\pgfanimationset{add}}
\tikzanimationdefineattribute{yskew}{code=\pgfanimationset{add}}
\tikzanimationdefineattribute{yslant}{pgf attribute name=yskew, parser=slant, code=\pgfanimationset{add}}




% The TikZ animation callbacks
%
% Description:
%
% The callbacks called by tikz.code.tex whenever an object is
% created. These callbacks will add the accumulated animation code. 

\def\tikz@animation@callback{%
  \tikz@anim@is@nodefalse%
  \tikz@animation@@callback%
}
\def\tikz@animation@node@callback{%
  \tikz@anim@is@nodetrue%
  \tikz@animation@@callback%
}

\def\tikz@animation@@callback{%
  \expandafter\ifx\csname tikz@anim@att@\tikz@id@name\endcsname\relax%
    % No named animation:
    % Now, check for auto animation:
    \expandafter\ifx\csname tikz@anim@att@\tikz@auto@id\endcsname\relax%
    \else%
      % Auto animation%
      \ifx\tikz@id@name\pgfutil@empty% Id set?
        % No, so set it
        \def\tikz@id@name{@auto}%
      \fi%
      \csname tikz@anim@att@\tikz@auto@id\endcsname%
      \expandafter\global\expandafter\let\csname tikz@anim@att@\tikz@auto@id\endcsname\relax%
    \fi%
  \else%
    % Named animation:
    \csname tikz@anim@att@\tikz@id@name\endcsname%
    \csname tikz@anim@att@\tikz@auto@id\endcsname% and unnamed animation
    \expandafter\global\expandafter\let\csname tikz@anim@att@\tikz@id@name\endcsname\relax%
    \expandafter\global\expandafter\let\csname tikz@anim@att@\tikz@auto@id\endcsname\relax%
  \fi%
  \pgfuseid{\tikz@id@name}%
}

\newif\iftikz@anim@is@node




% Attaches an animation to a named object (named in tikz)
%
% #1 = name of the object. If equal to the special text ".", the
%      next created object is meant.
% #2 = Animation code. When this code is executed, the following
%      things will be setup:
% 
%      \iftikz@anim@is@node will be set to true or false
%      depending on whether the name references a node.
%
%      \tikz@id@name will be set to the name of the object,
%      typically #1, except when #1 was ".", in this case another
%      name may have been used by the user, which will be used
%      instead. 
%
% Description:
%
% After the call, the next time an object named #1 is created in TikZ
% (using name=#1), the code #2 will be executed inside a scope to
% create an animation of the object.

\def\tikzanimationattachto#1#2{%
  {%
    \def\tikz@anim@name{#1}%
    \ifx\tikz@anim@name\pgfutil@empty%
      \tikzerror{Trying to attach an animation to an unnamed object. This should not happen.}%
    \else%
      \expandafter\ifx\csname tikz@anim@att@\tikz@anim@name\endcsname\relax%
        \expandafter\gdef\csname tikz@anim@att@\tikz@anim@name\endcsname{#2}%
      \else%
        \expandafter\let\expandafter\tikz@temp\csname tikz@anim@att@\tikz@anim@name\endcsname%
        \expandafter\def\expandafter\tikz@temp\expandafter{\tikz@temp#2}%
        \expandafter\global\expandafter\let\csname tikz@anim@att@\tikz@anim@name\endcsname\tikz@temp%
      \fi%
    \fi%
  }%
}      
\def\tikz@auto@id{.}
\expandafter\let\csname tikz@anim@att@\tikz@auto@id\endcsname\relax



% Add a timeline entry 
%
% #1 = The object (may be ".")
% #2 = The attribute (see pgfanimateattribute)
% #3 = Timeline sequence identifier
% #4 = code
%
% Description:
%
% This command stores an option with a timeline of an object. For each
% object--attribute--identifier tuple a timeline can be created, for
% which the values of #4 are collected. Later on, \pgfanimateattribute
% will be called for the pgf attribute associated with tikz attribute,
% the type associcated with it and initial code, followed by the
% accumulated values of #4.

\def\tikz@timeline@entry#1#2#3#4{%
  % First, does the object have an animation already attached?
  \expandafter\ifx\csname tikz@a@tlo@#1\endcsname\relax%
    % No, first entry!
    % Create call:
    \edef\pgf@marshal{\noexpand\tikzanimationattachto{#1}{\expandafter\noexpand\csname tikz@a@tlo@#1\endcsname}}%
    \pgf@marshal%
    \expandafter\gdef\csname tikz@a@tlo@#1\endcsname{\tikz@anim@cleanup{#1}}%
  \fi%
  % Second, does the timeline exist?
  \expandafter\ifx\csname tikz@a@tlc@#1@#2@#3\endcsname\relax%
    % No, first entry!
    % Create timeline...
    \expandafter\gdef\csname tikz@a@tlc@#1@#2@#3\endcsname{#4}%
    % ...and add to calls
    \expandafter\let\expandafter\pgf@temp\csname tikz@a@tlo@#1\endcsname%
    \expandafter\def\expandafter\pgf@temp@name\expandafter{\tikz@anim@create{#1}{#2}{#3}}%    
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\pgf@temp\expandafter\expandafter\expandafter{\expandafter\pgf@temp\pgf@temp@name}%
    \expandafter\global\expandafter\let\csname tikz@a@tlo@#1\endcsname\pgf@temp%
  \else%
    % Add to timeline:
    \expandafter\let\expandafter\pgf@temp\csname tikz@a@tlc@#1@#2@#3\endcsname%
    \expandafter\def\expandafter\pgf@temp\expandafter{\pgf@temp#4}%
    \expandafter\global\expandafter\let\csname tikz@a@tlc@#1@#2@#3\endcsname\pgf@temp%  
  \fi%
}


\def\tikz@anim@cleanup#1{%
  \expandafter\global\expandafter\let\csname tikz@a@tlo@#1\endcsname\relax%
}

\def\tikz@anim@create#1#2#3{%
  \expandafter\let\expandafter\tikz@temp\csname tikz@anim@def@pgf@attr@#2\endcsname%
  \expandafter\pgfanimateattributecode\expandafter{\tikz@temp}{%
    \iftikz@anim@is@node%
      \edef\tikz@anim@whom{\tikz@id@name\csname tikz@anim@def@is@node@#2\endcsname}%
    \else%
      \edef\tikz@anim@whom{\tikz@id@name\csname tikz@anim@def@no@node@#2\endcsname}%
    \fi%
    \pgfanimationset{whom=\tikz@anim@whom}%
    \expandafter\let\expandafter\tikz@animation@parser\csname tikz@anim@def@parser@#2\endcsname%
    \def\tikz@animation@time{0}%
    \csname tikz@anim@def@code@#2\endcsname%
    \csname tikz@a@tlc@#1@#2@#3\endcsname%
  }%
  \expandafter\global\expandafter\let\csname tikz@a@tlc@#1@#2@#3\endcsname\relax%
}




\endinput

