% Copyright 2015 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/frontendlayer/tikz/libraries/tikzlibraryanimations.code.tex,v 1.3 2015/08/18 14:43:11 tantau Exp $

\usepgfmodule{animations}



% 
% The \animate command 
%

\def\tikz@animate#1{%
  % First, go over the list and insert "animate=" before all entries
  % surrounded by braces
  {%
    \toks0={}%
    \tikz@anim@add@braces#1,\pgf@stop%
    \expandafter}%
  \expandafter\tikz@anim@do\expandafter{\the\toks0}%
}
\def\tikz@anim@add@braces{%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{%
    \pgfutil@ifnextchar\bgroup\tikz@anim@add@brace\tikz@anim@advace}}

\def\tikz@anim@advace#1,{%
  \toks0\expandafter{\the\toks0 #1,}%
  \tikz@anim@add@braces%
}
\def\tikz@anim@add@brace#1{%
  \toks0\expandafter{\the\toks0animate={#1},}%
  \pgfutil@ifnextchar,{\tikz@anim@add@braces@ok}{\tikzerror{Comma
      expected in animate options}}%
}
\def\tikz@anim@add@braces@ok,{\tikz@anim@add@braces}


\def\tikz@anim@do#1{%
  {%
    \pgfkeys{/tikz/animations/.cd,/tikz/every animate/.try,#1}%
    \tikz@animate@what%
  }%
}

\let\tikz@animate@whom\pgfutil@empty % A list of to-be-animated scopes
\let\tikz@animate@what\pgfutil@empty % A list of to-be-animated attributes

\pgfkeys{/tikz/animations/.cd,
  whom/.store in=\tikz@animate@whom,
  whom also/.code=\expandafter\def\expandafter\tikz@animate@whom\expandafter{\tikz@animate@whom,#1},
  name/.forward to=/pgf/animation/name,
  duration/.forward to=/pgf/animation/duration,
  duration/.value required,
  min duration/.forward to=/pgf/animation/min duration,
  max duration/.forward to=/pgf/animation/max duration,
  freeze at end/.forward to=/pgf/animation/freeze at end,
  freeze/.style={freeze at end={#1}},
  restart/.forward to=/pgf/animation/restart,
  repeats/.forward to=/pgf/animation/repeats,
  repeats/.default=,
  add/.forward to=/pgf/animation/add,
  begin/.forward to=/pgf/animation/begin,
  end/.forward to=/pgf/animation/end,
  begin on/.forward to=/pgf/animation/begin on,
  end on/.forward to=/pgf/animation/end on,
  next/.style={begin on={end,of=previous, delay=#1}},
  interpolation/.forward to=/pgf/animation/interpolation,
  key time/.forward to=/pgf/animation/key time,
  key progress/.forward to=/pgf/animation/key progress,
  key spline control/.forward to=/pgf/animation/key spline control,
  animate/.code=\tikz@animate{#1},
}

\def\tikz@anim@attr#1#2#3{%
  \expandafter\def\expandafter\tikz@animate@what\expandafter{\tikz@animate@what\tikz@animate@now{#1}{#2}{#3}}%
}

\def\tikz@anim@along#1#2{%
  \expandafter\def\expandafter\tikz@animate@what\expandafter{\tikz@animate@what\tikz@animate@along@now{#1}{#2}}%
}

\pgfkeys{/tikz/animations/.cd,
  fill opacity/.code=\tikz@anim@attr{fill opacity}{\tikz@anim@simple@parse}{#1},
  fill opacity +/.style={fill opacity={change by #1}},
  draw opacity/.code=\tikz@anim@attr{stroke opacity}{\tikz@anim@simple@parse}{#1},
  draw opacity +/.style={fill opacity={change by #1}},
  opacity/.style={fill opacity={#1},draw opacity={#1}},
  opacity +/.style={fill opacity +={#1}, draw opacity +={#1}},
  line width/.code=\tikz@anim@attr{line width}{\tikz@anim@simple@parse}{#1},
  line width +/.style={line width={change by #1}},
  scale/.code=\tikz@anim@attr{scale}{\tikz@anim@simple@parse}{#1},
  scale +/.style={scale={change by #1}},
  xskew/.code=\tikz@anim@attr{xskew}{\tikz@anim@simple@parse}{#1},
  xskew +/.style={xskew={change by #1}},
  skew x/.style={xskew={#1}},
  skew x +/.style={xskew +={#1}},
  yskew/.code=\tikz@anim@attr{yskew}{\tikz@anim@simple@parse}{#1},
  yskew +/.style={yskew={change by #1}},
  skew y/.style={yskew={#1}},
  skew y +/.style={yskew +={#1}},
  fill/.code=\tikz@anim@attr{fill}{\tikz@anim@simple@parse}{#1},
  fill +/.style={fill={change by #1}},
  draw/.code=\tikz@anim@attr{draw}{\tikz@anim@simple@parse}{#1},
  draw +/.style={draw={change by #1}},
  text/.code=\pgferror{not yet implement},
  text +/.style={text={change by #1}},
  color/.style={fill={#1},draw={#1}},
  color +/.style={fill +={#1}, draw +={#1}},
  shift/.code=\tikz@anim@attr{translate}{\tikz@anim@shift@parse}{#1},
  shift +/.code={shift={change by #1}},
  translate/.style={shift={#1}},
  translate +/.style={shift +={#1}},
  rotate/.code=\tikz@anim@attr{rotate}{\tikz@anim@simple@parse}{#1},
  rotate +/.code={rotate={change by #1}},
  rotate around/.code=\tikz@anim@attr{rotate}{\tikz@anim@rotate@parse}{#1},
  rotate aournd +/.code={rotate around={change by #1}},
  move along/.code=\tikz@anim@along{#1}{},
  drive along/.code=\tikz@anim@along{#1}{rotate along=true},
  view/.code=\tikz@anim@attr{view}{\tikz@anim@view@parse}{#1},
  view +/.code={view={change by #1}},
}

% The parsers:
\def\tikz@anim@simple@parse#1{\def\tikz@anim@result{#1}}

\def\tikz@anim@rotate@parse#1{%
  \edef\tikz@temp{#1}% get rid of active stuff
  \expandafter\tikz@anim@doparseA\tikz@temp%
}%
\def\tikz@anim@doparseA#1:{%
  \def\tikz@temp@rot{#1}%
  \tikz@scan@one@point\tikz@anim@doparseB%
}
\def\tikz@anim@doparseB#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@temp@rot,#1}%
}

\def\tikz@anim@shift@parse#1{\tikz@scan@one@point\tikz@anim@do@shift#1}
\def\tikz@anim@do@shift#1{\def\tikz@anim@result{#1}}


\def\tikz@anim@view@parse#1{%
  \tikz@scan@one@point\tikz@anim@view@parse@a#1%
}
\def\tikz@anim@view@parse@a#1{%
  \def\tikz@anim@result{{#1}}%
  \pgfutil@ifnextchar r{\tikz@anim@view@parsed@rec}{\tikz@scan@one@point\tikz@anim@view@parse@b}%
}
\def\tikz@anim@view@parsed@rec rectangle{\tikz@scan@one@point\tikz@anim@view@parse@b}%
\def\tikz@anim@view@parse@b#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@anim@result{#1}}%
}


% The main work function:

\def\tikz@animate@now#1#2#3{%
  {%
    \let\tikz@anim@now@options\pgfutil@empty%
    \let\tikz@anim@parser#2%
    \c@pgf@counta=0\relax%
    \tikz@anim@general@parse#3...\pgf@stop%
    \def\tikz@anim@caller{\pgfanimateattribute{#1}}%
    \tikz@animate@now@%
  }%
}
\def\tikz@animate@now@{%
  \ifx\tikz@animate@whom\pgfutil@empty%
    \expandafter\tikz@anim@caller\expandafter{\tikz@anim@now@options}%
  \else%
    \foreach\tikz@animate@one@whom in\tikz@animate@whom{%
      \ifx\tikz@animate@one@whom\pgfutil@empty\else%
        \def\tikz@temp{,whom=\tikz@animate@one@whom}%
        \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@one@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\tikz@temp}%
        \expandafter\tikz@anim@caller\expandafter{\tikz@anim@now@one@options}%
      \fi%
    }%
  \fi%
}

% The specical along parser

\def\tikz@animate@along@now#1#2{%
  {%
    \def\tikz@anim@now@options{#2,along softpath=}%
    \def\tikz@anim@caller{\pgfanimateattribute{motion}}%
    % Parse the path...
    {%
      \setbox0=\hbox{{% protext against side effects
          \pgfinterruptpath%
            \pgf@relevantforpicturesizefalse%
            \pgftransformreset%
            \tikz@scan@next@command#1\pgf@stop%
            \pgfsyssoftpath@getcurrentpath\tikz@anim@parsed@path%
            \global\let\tikz@anim@parsed@path\tikz@anim@parsed@path%
          \endpgfinterruptpath%
        }}%
    }%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\expandafter{\tikz@anim@parsed@path}}%
    \tikz@animate@now@%    
  }
}


% The parser

\def\tikz@anim@general@parse{\pgfutil@ifnextchar\pgf@stop\tikz@anim@general@done\tikz@anim@general@next}
\def\tikz@anim@general@next#1...{%
  \advance\c@pgf@counta by1\relax%
  \expandafter\def\csname tikz@anim@vals@\the\c@pgf@counta\endcsname{#1}%
  \tikz@anim@general@parse%
}
\def\tikz@anim@general@done\pgf@stop{%
  \ifnum\c@pgf@counta=1\relax%
    \expandafter\expandafter\expandafter\tikz@anim@handle@one\expandafter\expandafter\expandafter{\csname tikz@anim@vals@1\endcsname}%
  \else%   
    \ifnum\c@pgf@counta=2\relax%
      \expandafter\ifx\csname tikz@anim@vals@1\endcsname\pgfutil@empty%
        \tikz@anim@handle@two@special%
      \else%
        \tikz@anim@handle@many%
      \fi%
    \else%
      \tikz@anim@handle@many%
    \fi%
  \fi%    
}
\def\tikz@anim@handle@many{%
  \c@pgf@countb=0\relax%
  \pgfutil@loop%
  \ifnum\c@pgf@counta>\c@pgf@countb\relax%
    \advance\c@pgf@countb by 1\relax
    \edef\pgf@marshal{\noexpand\tikz@anim@parser{\csname tikz@anim@vals@\the\c@pgf@countb\endcsname}}%
    \pgf@marshal%
    \tikz@anim@add@to@now@options{value}%
  \pgfutil@repeat%
}
\def\tikz@anim@add@to@now@options#1{%
  \def\tikz@anim@temp{,#1=}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\tikz@anim@temp}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@now@options\expandafter\expandafter\expandafter{\expandafter\tikz@anim@now@options\expandafter{\tikz@anim@result}}%
}

\def\tikz@anim@handle@one#1{%
  \pgfutil@in@{\pgf@stop change by}{\pgf@stop#1}%
  \ifpgfutil@in@%
    \tikz@anim@handle@one@by#1\pgf@stop%
  \else%
    \tikz@anim@parser{#1}
    \tikz@anim@add@to@now@options{to}%
  \fi%
}
\def\tikz@anim@handle@one@by change by#1\pgf@stop{%
  \tikz@anim@parser{#1}
  \tikz@anim@add@to@now@options{by}%
}

\def\tikz@anim@handle@two@special{%
  \expandafter\expandafter\expandafter\tikz@anim@parser\expandafter\expandafter\expandafter{\csname tikz@anim@vals@\the\c@pgf@countb\endcsname}%
  \tikz@anim@add@to@now@options{to}%
}


% 
% Handling durations directly 
% 
% Syntax: Whenever an unknown key starts with a digit or a - or . or -.
% followed by a digit, then assume that a time is meant


\pgfkeys{/tikz/animations/.unknown/.code=%
  \let\tikz@anim@key\pgfkeyscurrentname%
  \def\tikz@anim@value{#1}%
  \expandafter\tikz@anim@test@time\tikz@anim@key xxx\pgf@stop%
}

\def\tikz@anim@test@time#1#2\pgf@stop{%
  \def\tikz@anim@temp{#1}%
  \ifx\tikz@anim@temp\tikz@dottext%
    \tikz@anim@test@time@dot#2\pgf@stop%
  \else%
    \tikz@anim@test@digit{#1}%
  \fi%
}
\def\tikz@anim@test@time@dot#1#2\pgf@stop{\tikz@anim@test@digit{#1}}
\def\tikz@dottext{.}
\def\tikz@anim@test@digit#1{%
  \expandafter\ifx\csname tikz@anim@digit@#1\endcsname\relax%
    \def\tikz@anim@prefix{/tikz/animations/}%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@prefix\expandafter\expandafter\expandafter{\expandafter\expandafter\expandafter{\expandafter\tikz@anim@prefix\tikz@anim@key}}%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@anim@prefix\expandafter\expandafter\expandafter{\expandafter\tikz@anim@prefix\expandafter{\tikz@anim@value}}%
    
    \pgfkeys{/errors/unknown key/.expand once=\tikz@anim@prefix}%
  \else%
    \pgfanimationset{duration/.expand once=\tikz@anim@key}%
  \fi%
}
\expandafter\let\csname tikz@anim@digit@0\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@1\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@2\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@3\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@4\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@5\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@6\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@7\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@8\endcsname\pgfutil@empty
\expandafter\let\csname tikz@anim@digit@9\endcsname\pgfutil@empty



% The animate {...} path command 
% 
% Syntax: animate [options] {%
%   <path commands> values{<text> "..." <text> "..." ... "..." <text>}
%   <path commands> values{<text> "..." <text> "..." ... "..." <text>}
%   ...
%   <path commands> values{<text> "..." <text> "..." ... "..." <text>}
% }

\def\tikz@animate@path#1#2{%
  \begingroup%
    % Ok, setup options
    \tikz@anim@path@steps0\relax%
    \pgfkeys{/tikz/animations/.cd,/tikz/every animate/.try,#1}%
    % Now, start construction of path values
    \ifnum\tikz@anim@path@steps=0\relax%
      % Ok, determine the number of steps, first
      \tikz@anim@path@steps1\relax%
      \tikz@anim@path@count#2values\pgf@stop%
    \fi%
    \tikz@anim@path@step0\relax%  
    \edef\steps{\the\tikz@anim@path@steps}%
    \pgfutil@loop%
    \ifnum\tikz@anim@path@step<\tikz@anim@path@steps%
      \advance\tikz@anim@path@step by1\relax%
      \edef\step{\the\tikz@anim@path@step}%
      \ifnum\tikz@anim@path@steps>1\relax
        \pgfmathsetmacro\t{(\step-1)/(\steps-1)}%
      \else%
        \def\t{1.0}%
      \fi%
      \t@pgf@toka{}%
      \tikz@anim@path@parser#2values\pgf@stop%
      % \t@pgf@toka now contains a path, hopefully...
      \pgfsys@animation@path{%
        {%
          \setbox0=\hbox{{% protext against side effects
              \pgfinterruptpath%
              \pgf@relevantforpicturesizefalse%
              \pgftransformreset%
              \expandafter\tikz@scan@next@command\the\t@pgf@toka\pgf@stop%
              \pgfsyssoftpath@invokecurrentpath%
              \endpgfinterruptpath%
            }}%
        }%
      }{values}
    \pgfutil@repeat%
    \pgfsys@animatepath%  
  \endgroup%
}

\pgfkeys{/tikz/animations/.cd,
  steps/.code=\pgfmathsetcount\tikz@anim@path@steps{#1}
}

\newcount\tikz@anim@path@steps
\newcount\tikz@anim@path@step


\def\tikz@anim@path@count#1values{%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{%
    \pgfutil@ifnextchar\bgroup\tikz@anim@path@count@vals\tikz@anim@path@count}%
}

\def\tikz@anim@path@count@vals#1{%
  \c@pgf@counta=1\relax%
  \tikz@anim@path@count@vals@#1...\pgf@stop%
}
\def\tikz@anim@path@count@vals@#1...{%
  \pgfutil@ifnextchar\pgf@stop\tikz@anim@path@count@vals@done{%
    \advance\c@pgf@counta by1\relax%
    \tikz@anim@path@count@vals@}%
}%
\def\tikz@anim@path@count@vals@done\pgf@stop{%
  \ifnum\c@pgf@counta>\tikz@anim@path@steps\relax%
    \tikz@anim@path@steps=\c@pgf@counta\relax%
  \fi%
}



\def\tikz@anim@path@parser#1values{%
  \pgfutil@ifnextchar\pgf@stop{%
    \t@pgf@toka\expandafter{\the\t@pgf@toka#1}%
    \pgfutil@gobble%
  }{%
    \pgfutil@ifnextchar\bgroup{%
      \t@pgf@toka\expandafter{\the\t@pgf@toka#1}%
      \tikz@anim@path@parse@vals%
    }
    {%
      \t@pgf@toka\expandafter{\the\t@pgf@toka#1values}%
      \tikz@anim@path@parser%
    }%
  }%
}

\def\tikz@anim@path@parse@vals#1{%
  \c@pgf@counta=1\relax%
  \tikz@anim@path@parse@vals@#1...\pgf@stop%
  \tikz@anim@path@parser%
}
\def\tikz@anim@path@parse@vals@#1...{%
  \ifnum\c@pgf@counta=\tikz@anim@path@step\relax%
    \t@pgf@toka\expandafter{\the\t@pgf@toka#1}%
  \fi%
  \advance\c@pgf@counta by1\relax%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble\tikz@anim@path@parse@vals@%
}%

\endinput
