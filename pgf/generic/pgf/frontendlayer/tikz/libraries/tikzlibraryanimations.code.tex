% Copyright 2015 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/frontendlayer/tikz/libraries/tikzlibraryanimations.code.tex,v 1.11 2015/09/11 11:18:38 tantau Exp $

\usepgfmodule{animations}



% 
% The \animate command 
%

\def\tikz@animate#1{%
  \tikz@anim@do{#1}%
  \pgfaliasid{local previous animation}{g@animation}%
  \pgfgaliasid{previous animation}{g@animation}%
}

\def\tikz@anim@do#1{%
  {%
    \pgfkeys{/handlers/animates/.code=\expandafter\tikz@animates@handler\expandafter{\pgfkeyscurrentpath}{##1}}%
    \pgfkeys{/handlers/first char syntax=true}%
    \pgfkeyssetvalue{/handlers/first char syntax/the character <}{\tikz@anim@parse@time}%
    \def\tikz@anim@t{0}
    \gdef\tikz@anim@last@t{0}
    \pgfkeys{/tikz/animations/.cd,default animates,/tikz/every animate/.try,#1}%
    \tikz@anim@list%
  }%
}

\let\tikz@anim@list\pgfutil@empty


%
% Defines a new tikz animation
% 

\def\tikz@new@anim#1#2#3#4{%
  % #1 = the name
  % #2 = the attribute
  % #3 = the whom
  % #4 = the options
  \expandafter\def\expandafter\tikz@anim@list\expandafter{\tikz@anim@list\tikz@anim@process{#1}{#2}{#3}{#4}}
  \expandafter\global\expandafter\let\csname tikz@anim@entries@#1\endcsname\pgfutil@empty%
}


\def\tikz@animates@handler#1#2{%
  \let\tikz@animates@attribute\pgfutil@empty%
  \let\tikz@animates@whom\pgfutil@empty%
  \def\tikz@animates@parser{simple}%
  {%
    \pgfkeys{/tikz/animations/animates/.cd,#2}%
    % This will set the type key
    % Other keys are ignored here
    \global\let\tikz@animates@g@parser\tikz@animates@parser%
    \global\let\tikz@animates@g@attribute\tikz@animates@attribute%
    \global\let\tikz@animates@g@whom\tikz@animates@whom%
  }%
  \ifx\tikz@animates@g@parser\pgfutil@empty%
    \tikzerror{.../animates must pick a type}%
  \else%
    \edef\tikz@temp{\noexpand\tikz@new@anim{#1}{\tikz@animates@g@attribute}{\tikz@animates@g@whom}}%
    \tikz@temp{#2}%
    \edef\pgf@marshal{\noexpand\pgfkeys{#1/.code=\noexpand\tikz@anim@parser{#1}{\tikz@animates@g@parser}{####1}}}%
    \pgf@marshal%
  \fi%
  \global\let\tikz@animates@g@parser\relax%
  \global\let\tikz@animates@g@attribute\relax%
  \global\let\tikz@animates@g@whom\relax%
}


\pgfkeys{
  /tikz/animations/animates/.cd,
  attribute/.code=\def\tikz@animates@attribute{#1},
  parser/.code=\def\tikz@animates@parser{#1},
  @type node/.initial=,
  @type scope/.initial=,
  @type path/.initial=,
  @type view/.initial=,
  @whom/.code=\expandafter\def\expandafter\tikz@animates@whom\expandafter{\tikz@animates@whom,#1},
  node/.style={@whom=node/{#1}},
  scope/.style={@whom=scope/{#1}},
  path/.style={@whom=path/{#1}},
  name/.forward to=/pgf/animation/name,
  freeze at end/.forward to=/pgf/animation/freeze at end,
  freeze/.style={freeze at end={#1}},
  restart/.forward to=/pgf/animation/restart,
  repeats/.forward to=/pgf/animation/repeats,
  repeats/.default=,
  add/.forward to=/pgf/animation/add,
  begin/.forward to=/pgf/animation/begin,
  end/.forward to=/pgf/animation/end,
  begin on/.forward to=/pgf/animation/begin on,
  end on/.forward to=/pgf/animation/end on,
  next/.style={begin on={end,of=local previous animation,delay=#1}},
  origin/.code=\tikz@anim@parse@origin{#1},
  %
  visible/.style={attribute=visible},
  opacity/.style={attribute=opacity},
  fill opacity/.style={attribute=fill opacity},
  draw opacity/.style={attribute=stroke opacity},
  text opacity/.style={attribute=fill opacity, @type node=.text},
  line width/.style={attribute=line width},
  fill/.style={attribute=fill, @type node=.background.path},
  draw/.style={attribute=stroke, @type node=.background.path},
  text/.style={attribute=fill, @type node=.text},
  view/.style={attribute=view, @type scope=.view},
  shift/.style={attribute=translate, parser=shift},
  rotate/.style={attribute=rotate},
  scale/.style={attribute=scale},
  xskew/.style={attribute=xskew},
  yskew/.style={attribute=yskew},
  xslant/.style={attribute=xskew, parser=slant},
  yslant/.style={attribute=yskew, parser=slant},
  move along/.style={attribute=motion, /utils/exec=\tikz@anim@along{#1}},
  drive along/.style={attribute=motion, /utils/exec=\tikz@anim@along{#1}, /pgf/animation/rotate along=true},
  morph/.style={attribute=softpath, parser=path, @type path=.path, @type node=.background.path},
}
\let\tikz@anim@default@whom\pgfutil@empty


% Default animates

\pgfkeys{
  /tikz/animations/@default whom/.store in=\tikz@anim@default@whom,
  /tikz/animations/default animates/.style={
    visible/animates={visible},
    opacity/animates={opacity},
    fill opacity/animates={fill opacity},
    draw opacity/animates={draw opacity},
    text opacity/animates={text opacity},
    line width/animates={line width},
    fill/animates={fill},
    draw/animates={draw},
    text/animates={text},
    view/animates={view},
    shift/animates={shift},
    rotate/animates={rotate},
    scale/animates={scale},
    xskew/animates={xskew},
    yskew/animates={yskew},
    xslant/animates={xslant},
    yslant/animates={yslant},
    morph/animates={morph},
    color/.style={fill={#1},draw={#1},text={#1}},
  }
}


% Timing keys

\pgfkeys{
  /tikz/animations/timing/.cd,
  t/.code=\pgfparsetime{#1}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t,
  t+/.code=\pgfparsetime{#1+\tikz@anim@last@t}\let\tikz@anim@t\pgftimeresult\global\let\tikz@anim@last@t\tikz@anim@t,
  t +/.style={t+={#1}}
}

\let\tikz@animates@whom\pgfutil@empty

\def\tikz@anim@parse@origin#1{%
  \tikz@scan@one@point\tikz@anim@parse@origin@#1\relax%
}
\def\tikz@anim@parse@origin@#1{\pgfkeys{/pgf/animation/origin={#1}}}



\def\tikz@anim@process#1#2#3#4{%
  \expandafter\let\expandafter\tikz@anim@temp\csname tikz@anim@entries@#1\endcsname%
  \expandafter\global\expandafter\let\csname tikz@anim@entries@#1\endcsname\relax%
  \ifx\tikz@anim@temp\pgfutil@empty%
  \else%
    % Ok, do something
    {%
      \def\tikz@whom@list{#3}%
      \ifx\tikz@whom@list\pgfutil@empty%
        \let\tikz@whom@list\tikz@anim@default@whom%
      \fi%
      \foreach\tikz@animate@whom@type/\tikz@animate@whom@obj in\tikz@whom@list{%
        \ifx\tikz@animate@whom@type\pgfutil@empty\else%
          \pgfanimateattributecode{#2}{%
            \pgfkeys{/tikz/animations/animates/.cd,#4}%
            \tikz@anim@temp%
            \expandafter\pgfutil@in@\expandafter.\expandafter{\tikz@animate@whom@obj}%
            \ifpgfutil@in@%
            \else%
              \edef\tikz@animate@whom@obj{\tikz@animate@whom@obj\pgfkeysvalueof{/tikz/animations/animates/@type \tikz@animate@whom@type}}%
            \fi%
            \pgfanimationset{whom=\tikz@animate@whom@obj}%
          }%
        \fi%
      }%
    }%
  \fi%
}



% The parsers

\def\tikz@anim@parser#1#2#3{%
  \csname tikz@anim@#2@parse\endcsname{#3}%
  \expandafter\let\expandafter\tikz@temp\csname tikz@anim@entries@#1\endcsname%
  \edef\tikz@@temp{\noexpand\pgf@anim@entry{\tikz@anim@t}{\tikz@anim@result}}%
  \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter\tikz@temp\expandafter\expandafter\expandafter{\expandafter\tikz@temp\tikz@@temp}%
  \expandafter\global\expandafter\let\csname tikz@anim@entries@#1\endcsname\tikz@temp%
}


\def\tikz@anim@simple@parse#1{\def\tikz@anim@result{#1}}

\def\tikz@anim@slant@parse#1{\pgfmathsetmacro\tikz@anim@result{atan(#1)}}

\def\tikz@anim@shift@parse#1{\tikz@scan@one@point\tikz@anim@do@shift#1}
\def\tikz@anim@do@shift#1{\def\tikz@anim@result{#1}}


\def\tikz@anim@view@parse#1{\tikz@anim@view@parse@#1\pgf@stop}%
\def\tikz@anim@view@parse@{%
  \pgfutil@ifnextchar({\tikz@scan@one@point\tikz@anim@view@parse@a}{\tikz@anim@view@node}%
}
\def\tikz@anim@view@parse@a#1{%
  \def\tikz@anim@result{{#1}}%
  \pgfutil@ifnextchar r{\tikz@anim@view@parsed@rec}{\tikz@scan@one@point\tikz@anim@view@parse@b}%
}
\def\tikz@anim@view@parsed@rec rectangle{\tikz@scan@one@point\tikz@anim@view@parse@b}%
\def\tikz@anim@view@parse@b#1{%
  \expandafter\def\expandafter\tikz@anim@result\expandafter{\tikz@anim@result{#1}}%
  \pgfutil@ifnextchar\pgf@stop\pgfutil@gobble{\tikzerror{Wrong view syntax}}%
}
\def\tikz@anim@view@node#1\pgf@stop{%
  \expandafter\ifx\csname pgf@sh@ns@#1\endcsname\relax%
    \tikzerror{Undefined node '#1'}%
  \else%
    % Compute a bounding box for the node:
    {%
      \pgf@process{\pgfpointanchor{#1}{west}}%
      \pgf@xa\pgf@x \pgf@ya\pgf@y
      \pgf@xb\pgf@x \pgf@yb\pgf@y
      \pgf@process{\pgfpointanchor{#1}{north}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{south}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%      
      \pgf@process{\pgfpointanchor{#1}{east}}%
      \ifdim\pgf@x<\pgf@xa \pgf@xa=\pgf@x\fi%
      \ifdim\pgf@x>\pgf@xb \pgf@xb=\pgf@x\fi%      
      \ifdim\pgf@y<\pgf@ya \pgf@ya=\pgf@y\fi%
      \ifdim\pgf@y>\pgf@yb \pgf@yb=\pgf@y\fi%
      \xdef\tikz@anim@result{{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}{\noexpand\pgfqpoint{\the\pgf@xb}{\the\pgf@yb}}}
    }%
  \fi%
}

\def\tikz@anim@path@parse#1{%
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \expandafter\tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@result%
        \global\let\tikz@anim@result\tikz@anim@result%
        \endpgfinterruptpath%
      }}%
  }%
}



% The special along parser

\def\tikz@anim@along#1{%
  % Parse the path...
  {%
    \setbox0=\hbox{{% protext against side effects
        \pgfinterruptpath%
        \pgf@relevantforpicturesizefalse%
        \tikz@scan@next@command#1\pgf@stop%
        \pgfsyssoftpath@getcurrentpath\tikz@anim@parsed@path%
        \global\let\tikz@anim@parsed@path\tikz@anim@parsed@path%
        \endpgfinterruptpath%
      }}%
  }%
  \pgfanimationset{along softpath=\tikz@anim@parsed@path}
}


% Timing parser

\def\tikz@anim@parse@time#1{\begingroup\tikz@anim@parse@time@#1\pgf@stop\endgroup}

\def\tikz@anim@parse@time@<#1>{%
  \pgfkeys{/tikz/animations/timing/.cd,#1}%
  \pgfutil@ifnextchar<\tikz@anim@parse@time@\tikz@anim@parse@time@done%
}

\def\tikz@anim@parse@time@done#1\pgf@stop{%
  \pgfkeys{/tikz/animations/.cd,#1}%
}




\endinput

